<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sera Rework — Mid Lane Kit Concept — Interactive Game Mod</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Rajdhani:wght@300;400;500;600;700&family=Orbitron:wght@400;500;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box;user-select:none}
html,body{width:100%;height:100%;overflow:hidden;background:#010a13;font-family:'Rajdhani',sans-serif;
cursor:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='28' height='28'%3E%3Ccircle cx='14' cy='14' r='3' fill='none' stroke='%23c8aa6e' stroke-width='1'/%3E%3Cline x1='14' y1='6' x2='14' y2='10' stroke='%23c8aa6e'/%3E%3Cline x1='14' y1='18' x2='14' y2='22' stroke='%23c8aa6e'/%3E%3Cline x1='6' y1='14' x2='10' y2='14' stroke='%23c8aa6e'/%3E%3Cline x1='18' y1='14' x2='22' y2='14' stroke='%23c8aa6e'/%3E%3C/svg%3E") 14 14,crosshair}

/* ═══ SPLASH ═══ */
#splash{position:fixed;inset:0;z-index:9000;display:flex;flex-direction:column;align-items:center;justify-content:center;
background:linear-gradient(180deg,#010A13,#0A1428 50%,#091428);transition:opacity .7s}
#splash.hide{opacity:0;pointer-events:none}
#splash::before{content:'';position:absolute;inset:24px;border:1px solid rgba(200,170,110,.12);pointer-events:none}
#splash h1{font-family:'Cinzel',serif;font-size:clamp(22px,4.5vw,50px);letter-spacing:5px;text-transform:uppercase;
background:linear-gradient(180deg,#f0e6d2,#c8aa6e 50%,#785a28);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
#splash h2{font-family:'Cinzel',serif;font-size:clamp(12px,2vw,22px);color:#c8aa6e;letter-spacing:3px;font-weight:400;margin-bottom:4px}
.ssub{font-size:13px;color:#5b5a56;letter-spacing:2px;margin-bottom:6px}
.scr{font-size:12px;color:#c89b3c;margin-bottom:24px;letter-spacing:1px}
.srow{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;padding:0 16px}
.sbtn{padding:10px 28px;border:1px solid #c8aa6e;background:linear-gradient(180deg,rgba(30,35,40,.9),rgba(10,20,30,.95));
color:#cdbe91;font-family:'Cinzel',serif;font-size:13px;letter-spacing:2px;cursor:pointer;text-transform:uppercase;
clip-path:polygon(6px 0,calc(100% - 6px) 0,100% 6px,100% calc(100% - 6px),calc(100% - 6px) 100%,6px 100%,0 calc(100% - 6px),0 6px);transition:all .2s}
.sbtn:hover{background:linear-gradient(180deg,rgba(60,50,30,.9),rgba(30,25,15,.95));color:#f0e6d2;box-shadow:0 0 20px rgba(200,170,110,.2)}
.sbtn small{display:block;font-family:'Rajdhani';font-size:10px;color:#5b5a56;margin-top:2px;text-transform:none;letter-spacing:0}
@keyframes demoglow{0%,100%{box-shadow:0 0 15px rgba(244,143,177,.3),0 0 30px rgba(244,143,177,.15)}50%{box-shadow:0 0 25px rgba(244,143,177,.5),0 0 50px rgba(244,143,177,.25)}}

/* ═══ INFO SCREEN ═══ */
.info-section{margin-bottom:22px;background:rgba(10,20,40,.5);border:1px solid rgba(200,170,110,.08);border-radius:6px;padding:16px 18px;transition:border-color .2s}
.info-section:hover{border-color:rgba(200,170,110,.2)}
.info-title{font:bold 14px Orbitron;color:#c8aa6e;letter-spacing:2px;margin-bottom:8px}
.info-body{font:14px/1.7 'Rajdhani',sans-serif;color:rgba(240,230,210,.75)}
.info-key-row{margin:4px 0;display:flex;align-items:flex-start;gap:8px}
.info-key{display:inline-block;background:rgba(200,170,110,.12);border:1px solid rgba(200,170,110,.25);border-radius:3px;padding:1px 8px;font:bold 12px Orbitron;color:#c8aa6e;min-width:38px;text-align:center;flex-shrink:0}

/* ═══ GAME WRAPPER — full screen canvas + bottom HUD overlay ═══ */
#wrap{position:fixed;inset:0;display:none;flex-direction:column}
#wrap.on{display:flex}
canvas{flex:1;width:100%;display:block}

/* ═══ TOP BAR — minimal ═══ */
.topbar{position:fixed;top:0;left:0;right:0;z-index:40;display:flex;justify-content:space-between;align-items:center;
padding:6px 12px;pointer-events:none}
.topbar>*{pointer-events:auto}
.tmode{font-family:'Orbitron';font-size:9px;color:#5b5a56;letter-spacing:2px;text-transform:uppercase}
.tback{padding:5px 16px;border:1px solid rgba(200,170,110,.45);background:rgba(1,10,19,.85);color:#cdbe91;
font-size:12px;font-family:'Rajdhani';font-weight:700;cursor:pointer;letter-spacing:1px;backdrop-filter:blur(4px);border-radius:3px;transition:all .15s}
.tback:hover{border-color:#c8aa6e;color:#f0e6d2;background:rgba(200,170,110,.15)}

/* ═══ BOTTOM HUD — LoL style ═══ */
.bhud{position:fixed;bottom:0;left:0;right:0;z-index:30;
display:flex;align-items:flex-end;justify-content:center;
padding:0 10px 6px;pointer-events:none;
background:linear-gradient(0deg,rgba(1,10,19,.92) 0%,rgba(1,10,19,.7) 60%,transparent 100%)}
.bhud>*{pointer-events:auto}

/* The three sections of the bottom HUD */
.bhud-left{display:flex;align-items:flex-end;gap:4px;margin-right:10px}
.bhud-center{display:flex;align-items:flex-end;gap:8px}
.bhud-right{display:flex;align-items:flex-end;gap:6px;margin-left:10px}

/* ═══ ABILITY SLOTS (left section) ═══ */
.abslot{position:relative;width:52px;height:52px;border:2px solid #3c3c41;background:linear-gradient(180deg,#1e2328,#0a0e13);
cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:all .15s;
clip-path:polygon(4px 0,calc(100% - 4px) 0,100% 4px,100% calc(100% - 4px),calc(100% - 4px) 100%,4px 100%,0 calc(100% - 4px),0 4px)}
.abslot:hover{border-color:#c8aa6e;background:linear-gradient(180deg,#2a2f35,#12171d)}
.abslot.rdy{border-color:#c8aa6e}
.abslot.nr{border-color:#3c3c41;opacity:.5}
.abslot.ocd{border-color:#3c3c41;opacity:.4}
.abslot .akey{font-family:'Orbitron';font-size:14px;font-weight:700;color:#f0e6d2;line-height:1}
.abslot .aname{font-size:8px;color:#5b5a56;letter-spacing:.5px;line-height:1}
.abslot .acost{position:absolute;bottom:1px;left:8px;right:8px;height:3px;border-radius:1px}
.abslot .acost.m{background:linear-gradient(90deg,#1a5a8a,#3b92d3)}
.abslot .acost.en{background:linear-gradient(90deg,#8b6914,#daa520)}
.abslot .acost.fr{background:#3c3c41}
.abslot .aov{position:absolute;inset:0;background:rgba(0,0,0,.65);display:flex;align-items:center;justify-content:center;
font-family:'Orbitron';font-size:16px;color:#ef5350;font-weight:700}

/* ═══ CHAMPION PORTRAIT (center-left) ═══ */
.champ-frame{width:58px;height:58px;border:2px solid #c8aa6e;background:#0a1428;position:relative;
clip-path:polygon(6px 0,calc(100% - 6px) 0,100% 6px,100% calc(100% - 6px),calc(100% - 6px) 100%,6px 100%,0 calc(100% - 6px),0 6px);flex-shrink:0}
.champ-frame canvas{width:100%;height:100%}
.champ-lvl{position:absolute;bottom:-3px;left:50%;transform:translateX(-50%);background:#010a13;border:1px solid #c8aa6e;
border-radius:50%;width:18px;height:18px;display:flex;align-items:center;justify-content:center;
font-family:'Orbitron';font-size:8px;color:#f0e6d2}

/* ═══ RESOURCE BARS (center) ═══ */
.res-stack{display:flex;flex-direction:column;gap:2px;width:clamp(160px,22vw,260px)}
.rbar{height:12px;background:#1e2328;border:1px solid #5b5a56;position:relative;overflow:hidden}
.rfill{height:100%;transition:width .15s}
.rfill.hp{background:linear-gradient(90deg,#1a7a28,#2faf3f)}
.rfill.mp{background:linear-gradient(90deg,#1a5a8a,#3b92d3)}
.rfill.ep{background:linear-gradient(90deg,#8b6914,#daa520)}
.rval{position:absolute;right:6px;top:50%;transform:translateY(-50%);font-size:10px;color:#f0e6d2;font-family:'Orbitron';text-shadow:0 1px 2px #000;z-index:2;letter-spacing:.5px}
.rlbl{position:absolute;left:6px;top:50%;transform:translateY(-50%);font-size:8px;color:rgba(240,230,210,.4);font-family:'Orbitron';z-index:2;letter-spacing:1px}
.emarks{position:absolute;inset:0;display:flex;pointer-events:none}
.emarks span{flex:1;border-right:2px solid #1e2328}
.emarks span:last-child{border:none}

/* ═══ PASSIVE + GUARDS (center-right) ═══ */
.pg-stack{display:flex;flex-direction:column;align-items:center;gap:3px}
.passive-b{padding:3px 10px;border:1px solid;font-family:'Orbitron';font-size:8px;letter-spacing:1px;text-align:center;text-transform:uppercase;min-width:70px}
.passive-b.dm{border-color:#3b92d3;color:#3b92d3;background:rgba(59,146,211,.08)}
.passive-b.am{border-color:#e84393;color:#f48fb1;background:rgba(232,67,147,.1);animation:ap 1.5s infinite}
@keyframes ap{0%,100%{box-shadow:none}50%{box-shadow:0 0 8px rgba(232,67,147,.3)}}
.guard-row{display:flex;gap:3px}
.gg{width:14px;height:18px;clip-path:polygon(50% 0,100% 30%,100% 70%,50% 100%,0 70%,0 30%);transition:all .3s}
.gg.up{background:linear-gradient(180deg,#ffd700,#daa520);box-shadow:0 0 4px rgba(255,215,0,.5)}
.gg.dn{background:#1e2328}.gg.cd{background:#5a0000;animation:cdf 1s infinite}
@keyframes cdf{0%,100%{opacity:.5}50%{opacity:1}}
.guard-lbl{font-family:'Orbitron';font-size:6px;color:#5b5a56;letter-spacing:.5px}

/* ═══ DEMO BUTTONS (right section) ═══ */
.demo-col{display:flex;flex-direction:column;gap:3px;align-items:center}
.dmb{padding:14px 32px;border:2px solid #f48fb1;background:rgba(244,143,177,.1);color:#f48fb1;
font:bold 15px Orbitron;cursor:pointer;letter-spacing:2px;white-space:nowrap;border-radius:6px;text-transform:uppercase;animation:demoglow 2s ease-in-out infinite}
.dmb:hover{border-color:#f48fb1;background:rgba(244,143,177,.2);box-shadow:0 0 35px rgba(244,143,177,.5)}

/* ═══ ABILITY SIDE PANEL (demo mode) ═══ */
#abilPanel{position:fixed;top:0;right:0;width:clamp(240px,22vw,320px);height:100%;z-index:35;
overflow-y:auto;overflow-x:hidden;background:linear-gradient(180deg,rgba(1,10,19,.95),rgba(10,20,40,.92));
border-left:1px solid rgba(200,170,110,.15);display:none;padding:36px 12px 80px;
scrollbar-width:thin;scrollbar-color:rgba(200,170,110,.2) transparent}
#abilPanel::-webkit-scrollbar{width:4px}
#abilPanel::-webkit-scrollbar-thumb{background:rgba(200,170,110,.25);border-radius:2px}
#abilPanel.on{display:block}
.ap-title{font-family:'Cinzel',serif;font-size:11px;color:#c8aa6e;letter-spacing:2px;text-transform:uppercase;
margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid rgba(200,170,110,.12)}
.ap-ab{margin-bottom:12px;padding:8px;border:1px solid rgba(200,170,110,.08);background:rgba(10,20,40,.5);
border-radius:2px;transition:border-color .3s}
.ap-ab.hi{border-color:rgba(232,67,147,.4);background:rgba(232,67,147,.06)}
.ap-ab-head{display:flex;align-items:center;gap:6px;margin-bottom:4px}
.ap-ab-key{font-family:'Orbitron';font-size:14px;font-weight:700;width:24px;height:24px;
display:flex;align-items:center;justify-content:center;border:1px solid #5b5a56;color:#f0e6d2;flex-shrink:0}
.ap-ab-key.passive{font-size:10px;background:linear-gradient(180deg,#1a3a5a,#0a1428);border-color:#3b92d3}
.ap-ab-key.q{background:linear-gradient(180deg,#4a1a3a,#1a0a18);border-color:#e84393}
.ap-ab-key.w{background:linear-gradient(180deg,#3a3a1a,#181808);border-color:#daa520}
.ap-ab-key.e{background:linear-gradient(180deg,#1a2a4a,#080a18);border-color:#2196f3}
.ap-ab-key.r{background:linear-gradient(180deg,#2a1a4a,#0a0818);border-color:#aa00ff}
.ap-ab-name{font-family:'Cinzel',serif;font-size:11px;color:#f0e6d2;letter-spacing:1px}
.ap-ab-cost{font-family:'Orbitron';font-size:7px;color:#5b5a56;margin-left:auto;letter-spacing:.5px}
.ap-ab-desc{font-size:11px;color:#8c8c8c;line-height:1.45;margin-top:2px}
.ap-ab-desc b{color:#cdbe91;font-weight:600}
.ap-ab-desc .tag-mana{color:#3b92d3;font-weight:600;font-size:10px}
.ap-ab-desc .tag-energy{color:#daa520;font-weight:600;font-size:10px}
.ap-ab-desc .tag-free{color:#5b5a56;font-weight:600;font-size:10px}
.ap-ab-lore{font-size:9px;color:#5b5a56;font-style:italic;margin-top:4px;line-height:1.3;
border-top:1px solid rgba(200,170,110,.06);padding-top:3px}
.ap-resource{margin-bottom:12px;padding:8px;border:1px solid rgba(200,170,110,.08);background:rgba(10,20,40,.5);border-radius:2px}
.ap-resource-t{font-family:'Cinzel',serif;font-size:10px;color:#daa520;letter-spacing:1px;margin-bottom:3px}
.ap-resource-d{font-size:10px;color:#8c8c8c;line-height:1.4}
.ap-resource-d b{color:#cdbe91}

/* ═══ RESPAWN OVERLAY ═══ */
.rspn{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:50;
background:rgba(1,10,19,.9);border:1px solid rgba(200,170,110,.3);padding:12px 30px;text-align:center;
font-family:'Cinzel';color:#c8aa6e;font-size:16px;letter-spacing:2px;display:none}
.rspn.on{display:block}

/* ═══ HINT (above HUD) ═══ */
.hint{position:fixed;bottom:76px;left:50%;transform:translateX(-50%);z-index:25;
font-size:9px;color:rgba(91,90,86,.6);letter-spacing:1px;white-space:nowrap;pointer-events:none}

@media(max-width:700px){
  .abslot{width:42px;height:42px}.abslot .akey{font-size:11px}
  .res-stack{width:120px}
  .rbar{height:10px}.rval{font-size:8px}.rlbl{font-size:6px}
  .hint{display:none}
}
</style>
</head>
<body>

<!-- SPLASH MENU -->
<div id="splash">
<h1>Sera Rework</h1><h2>Mid Lane Kit Concept</h2>
<div class="ssub">INTERACTIVE GAME MOD</div>
<div class="scr">Proposed by JLTHAKAD · @jlthakad</div>
<div style="color:rgba(200,170,110,.35);font-size:9px;max-width:420px;text-align:center;line-height:1.4;margin-top:8px;font-family:'Rajdhani',sans-serif">This is an original fan concept and game design proposal by JLTHAKAD. All gameplay mechanics, ability designs, resource systems, and visual implementations are original work. This is not affiliated with, endorsed by, or produced by any game company. Character concepts are used under fair use for commentary and creative expression.</div>
<div class="srow">
<button class="sbtn" onclick="go('practice')">Practice<small>Fight dummies · Jungler ganks</small></button>
<button class="sbtn" onclick="go('demo')">Watch Demo<small>Visual combo demonstrations</small></button>
<button class="sbtn" onclick="go('kite')">Aim Trainer<small>10 Levels · Dodge · Aim · Score</small></button>
<button class="sbtn" onclick="go('sandbox')">Sandbox<small>S/D/H spawn dummies</small></button>
</div>
<button class="sbtn" onclick="showInfo()" style="margin-top:12px;border-color:#5b5a56;color:#8c8c7a;">ℹ How To Play<small>Controls, modes, and mechanics explained</small></button>
</div>

<!-- INFO SCREEN -->
<div id="infoScreen" style="display:none;position:fixed;inset:0;z-index:9500;background:linear-gradient(180deg,#010A13,#0A1428 50%,#091428);overflow-y:auto;">
<div style="max-width:680px;margin:0 auto;padding:30px 24px 60px;">
  <button onclick="hideInfo()" style="position:fixed;top:14px;right:20px;z-index:9999;background:rgba(10,20,40,.85);border:1px solid rgba(200,170,110,.3);color:#c8aa6e;font:bold 13px Orbitron;padding:8px 18px;cursor:pointer;border-radius:4px;">‹ BACK</button>

  <h1 style="font-family:'Cinzel',serif;font-size:28px;letter-spacing:4px;text-align:center;background:linear-gradient(180deg,#f0e6d2,#c8aa6e);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:4px;">HOW TO PLAY</h1>
  <div style="text-align:center;color:#5b5a56;font:12px Orbitron;letter-spacing:2px;margin-bottom:28px;">SERA REWORK — INTERACTIVE KIT DEMO</div>

  <!-- WHAT IS THIS -->
  <div class="info-section">
    <div class="info-title">WHAT IS THIS?</div>
    <div class="info-body">
      This is an interactive demo for a proposed Seraphine mid lane kit rework by <span style="color:#c89b3c;">JLTHAKAD</span>. It lets you play with the reworked abilities, see how they work in action, and experience the dual mana/energy resource system that makes this kit unique. Choose a mode from the main menu to get started.
    </div>
  </div>

  <!-- CONTROLS -->
  <div class="info-section">
    <div class="info-title">CONTROLS</div>
    <div class="info-body">
      <div class="info-key-row"><span class="info-key">Right-Click</span> Move Seraphine to that position</div>
      <div class="info-key-row"><span class="info-key">Hover Mouse</span> Aim — abilities fire toward your cursor</div>
      <div class="info-key-row"><span class="info-key">Q</span> <span style="color:#e84393;">Listen</span> — wide area burst (mana). During recast window, press Q again for <span style="color:#ffd700;">Speak</span> — precision burst (energy)</div>
      <div class="info-key-row"><span class="info-key">W</span> <span style="color:#ffd700;">Set the Stage</span> — place a guard stage at your feet (up to 3). Guards absorb damage while you stand on them. When a guard breaks, you gain energy.</div>
      <div class="info-key-row"><span class="info-key">E</span> <span style="color:#2196f3;">Beat Drop</span> — line skillshot that breaks enemy shields (mana)</div>
      <div class="info-key-row"><span class="info-key">R</span> <span style="color:#aa00ff;">Cover Your Ears</span> — massive wave that silences and reduces healing (energy). Enemies hit take amplified Q damage.</div>
    </div>
  </div>

  <!-- RESOURCE SYSTEM -->
  <div class="info-section">
    <div class="info-title">DUAL RESOURCE SYSTEM</div>
    <div class="info-body">
      Seraphine uses <span style="color:#4fc3f7;">Mana</span> and <span style="color:#ffd700;">Energy</span> simultaneously — the first champion in League to do so.
      <div style="margin-top:8px;">
        <span style="color:#4fc3f7;font-weight:bold;">Mana</span> — regenerates naturally. Fuels Q1 (Listen) and E (Beat Drop). These are always available for poking and trading.
      </div>
      <div style="margin-top:4px;">
        <span style="color:#ffd700;font-weight:bold;">Energy</span> — does NOT regenerate. Only gained when a guard breaks on your W stage. Fuels Q2 (Speak) and R (Cover Your Ears). You must take damage on your stages to unlock your strongest abilities.
      </div>
      <div style="margin-top:8px;color:rgba(240,230,210,.55);font-style:italic;">The core loop: place stages → absorb damage → guards break → energy fills → unleash devastating combos.</div>
    </div>
  </div>

  <!-- PASSIVE -->
  <div class="info-section">
    <div class="info-title">PASSIVE — DAMPENER / AMPLIFIER</div>
    <div class="info-body">
      <span style="color:#4fc3f7;">Off stage (Dampener):</span> reduced ability range, but passively weakens nearby enemy abilities.
      <br><span style="color:#e84393;">On stage (Amplifier):</span> increased ability range, and your next basic ability echoes — casting a second time automatically.
    </div>
  </div>

  <!-- MODE: PRACTICE -->
  <div class="info-section">
    <div class="info-title" style="color:#e84393;">MODE — PRACTICE</div>
    <div class="info-body">
      Fight against an AI dummy that uses abilities and attacks you in lane. A jungler will periodically gank.
      <div style="margin-top:6px;">
        <span style="color:#c8aa6e;">How to play:</span> Right-click to move, hover to aim, use Q/W/E/R to fight the dummy. Place W stages to absorb damage and generate energy. Try to kill the dummy using full combos. The dummy respawns after death so you can practice indefinitely.
      </div>
      <div style="margin-top:4px;">
        <span style="color:#c8aa6e;">Turrets:</span> Your ally turret (bottom) and enemy turret (top) are active. Standing in enemy turret range will get you shot. Turrets have dashed range circles.
      </div>
      <div style="margin-top:4px;">
        <span style="color:#c8aa6e;">Jungler:</span> An enemy jungler appears from the side periodically. Survive ganks by retreating through your W stages — each guard absorbs damage as you run.
      </div>
    </div>
  </div>

  <!-- MODE: DEMO -->
  <div class="info-section">
    <div class="info-title" style="color:#f48fb1;">MODE — WATCH DEMO</div>
    <div class="info-body">
      Sit back and watch — the AI controls Seraphine and performs 6 scripted combo demonstrations showing different aspects of the kit.
      <div style="margin-top:6px;">
        <span style="color:#c8aa6e;">Navigation:</span> Use the <b>◀ PREV</b> and <b>NEXT ▶</b> buttons at the top to skip between rounds. Each round showcases a specific mechanic: lane trading, R+Q2 guard resets, shield breaking, all-in executes, extended fights, and energy refund on death.
      </div>
      <div style="margin-top:4px;">
        <span style="color:#c8aa6e;">What to watch:</span> Pay attention to the ability panel on the right — it highlights which ability is being used. The Q slot visually swaps between Listen (Q1) and Speak (Q2) during recast windows. Watch how energy fills as guards break, and how the full combo chains together.
      </div>
    </div>
  </div>

  <!-- MODE: AIM TRAINER -->
  <div class="info-section">
    <div class="info-title" style="color:#ffd700;">MODE — AIM TRAINER</div>
    <div class="info-body">
      A 10-level dodge-and-aim challenge. Colored targets spawn across the arena — match the correct ability to each target color while dodging incoming red projectiles.
      <div style="margin-top:8px;">
        <div class="info-key-row"><span style="color:#e84393;font-weight:bold;">● PINK</span> — press <b style="color:#e84393;">Q</b> (100 pts)</div>
        <div class="info-key-row"><span style="color:#ffd700;font-weight:bold;">● GOLD ★</span> — press <b style="color:#ffd700;">Q</b> — smaller target, worth 2x (200 pts)</div>
        <div class="info-key-row"><span style="color:#00bcd4;font-weight:bold;">● CYAN</span> — press <b style="color:#2196f3;">E</b> to shatter shield, THEN <b>Q</b> to finish (250 pts total)</div>
        <div class="info-key-row"><span style="color:#aa00ff;font-weight:bold;">● PURPLE</span> — press <b style="color:#aa00ff;">R</b> to silence, THEN <b>Q</b> for amplified damage (400 pts total)</div>
        <div class="info-key-row"><span style="color:#ef5350;font-weight:bold;">● RED projectiles</span> — DODGE these! Getting hit <b>off stage = -50 pts</b> and streak lost. Standing on a <b style="color:#ffd700;">W stage = safe</b>.</div>
      </div>
      <div style="margin-top:8px;">
        <span style="color:#c8aa6e;">No cooldowns</span> — abilities have zero cooldown and zero cost in this mode. Focus purely on aiming and dodging.
      </div>
      <div style="margin-top:4px;">
        <span style="color:#c8aa6e;">Scoring:</span> Hits build a streak multiplier (+10% per consecutive hit, max 3x). Misses cost -30 pts. Targets that expire reset your streak. Levels are graded S+ through F.
      </div>
      <div style="margin-top:4px;">
        <span style="color:#c8aa6e;">Difficulty:</span> Level 1 is slow with big targets and light fire. Level 10 has tiny fast targets with relentless projectile storms. Each level lasts 60–120 seconds.
      </div>
    </div>
  </div>

  <!-- MODE: SANDBOX -->
  <div class="info-section">
    <div class="info-title" style="color:#4fc3f7;">MODE — SANDBOX</div>
    <div class="info-body">
      A free-form arena with no objectives. Spawn dummies on demand and practice anything you want.
      <div style="margin-top:6px;">
        <div class="info-key-row"><span class="info-key">S</span> Spawn a standard dummy (fights back with abilities)</div>
        <div class="info-key-row"><span class="info-key">D</span> Spawn a training dummy (stands still, infinite HP)</div>
        <div class="info-key-row"><span class="info-key">H</span> Spawn a high-HP tank dummy</div>
      </div>
      <div style="margin-top:4px;">No turrets, no jungler, no time limits. Just you and your targets.</div>
    </div>
  </div>

  <!-- LORE -->
  <div class="info-section">
    <div class="info-title" style="color:#c89b3c;">ABOUT THE REWORK</div>
    <div class="info-body">
      Every ability in this kit is pulled directly from Seraphine's biography and color story. The dual resource system reflects her journey — mana is her natural gift (always available), energy is power earned through suffering (guards must break). The Dampener/Amplifier passive mirrors her transformation from repressed child to performing artist. Her W stages represent the guards she watched people refuse to put down.
      <div style="margin-top:6px;color:rgba(240,230,210,.55);">
        Read the full proposal for detailed lore connections, item builds, rune pages, and the complete design philosophy behind making Seraphine a true mid lane champion.
      </div>
    </div>
  </div>

  <div style="text-align:center;margin-top:24px;color:rgba(200,170,110,.25);font:10px Orbitron;letter-spacing:1px;">PROPOSED BY JLTHAKAD · @JLTHAKAD</div>
</div>
</div>

<!-- KITE LEVEL SELECT -->
<div id="kiteSelect" style="display:none;position:fixed;inset:0;z-index:60;background:rgba(1,10,19,.95);flex-direction:column;align-items:center;justify-content:center;font-family:'Rajdhani',sans-serif;overflow-y:auto;padding:24px 16px;">
  <div style="font:bold 22px Orbitron;color:#f48fb1;letter-spacing:3px;margin-bottom:4px;">AIM TRAINER</div>
  <div style="color:rgba(240,230,210,.5);font-size:13px;margin-bottom:16px;">Hit targets · Dodge projectiles · Use your full kit</div>
  <div id="kiteLvls" style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;max-width:460px;"></div>
  <button onclick="menu()" style="margin-top:18px;background:none;border:1px solid rgba(200,170,110,.3);color:#c8aa6e;font:12px Orbitron;padding:6px 20px;cursor:pointer;border-radius:4px;">‹ BACK TO MENU</button>
</div>

<!-- KITE RESULTS -->
<div id="kiteResults" style="display:none;position:fixed;inset:0;z-index:60;background:rgba(1,10,19,.92);flex-direction:column;align-items:center;justify-content:center;font-family:'Rajdhani',sans-serif;">
  <div id="krGrade" style="font:bold 72px Orbitron;color:#ffd700;text-shadow:0 0 30px rgba(255,215,0,.5);"></div>
  <div id="krTitle" style="font:bold 18px Orbitron;color:#f48fb1;margin-bottom:12px;"></div>
  <div id="krStats" style="color:#f0e6d2;font-size:15px;line-height:2;text-align:center;"></div>
  <div style="display:flex;gap:12px;margin-top:20px;">
    <button onclick="kiteStart(G.kite.lvl)" style="background:rgba(244,143,177,.15);border:1px solid #f48fb1;color:#f48fb1;font:bold 13px Orbitron;padding:8px 20px;cursor:pointer;border-radius:4px;">RETRY</button>
    <button onclick="showKiteSelect()" style="background:rgba(200,170,110,.1);border:1px solid rgba(200,170,110,.3);color:#c8aa6e;font:13px Orbitron;padding:8px 20px;cursor:pointer;border-radius:4px;">LEVELS</button>
    <button onclick="menu()" style="background:none;border:1px solid rgba(200,170,110,.2);color:rgba(240,230,210,.5);font:12px Orbitron;padding:8px 20px;cursor:pointer;border-radius:4px;">MENU</button>
  </div>
</div>

<!-- KITE HUD -->
<div id="kiteHUD" style="display:none;position:fixed;top:38px;right:8px;z-index:50;font-family:'Rajdhani',sans-serif;text-align:right;">
  <div id="khScore" style="font:bold 28px Orbitron;color:#ffd700;text-shadow:0 0 10px rgba(255,215,0,.3);"></div>
  <div id="khStreak" style="font:bold 14px Orbitron;color:#f48fb1;min-height:18px;"></div>
  <div id="khAcc" style="font:13px Rajdhani;color:rgba(240,230,210,.6);"></div>
  <div id="khTimer" style="font:bold 22px Orbitron;color:#f0e6d2;margin-top:4px;"></div>
  <div id="khLevel" style="font:11px Orbitron;color:rgba(200,170,110,.5);letter-spacing:2px;"></div>
</div>

<!-- GAME -->
<div id="wrap">
<canvas id="c"></canvas>

<!-- TOP BAR -->
<div class="topbar">
  <span class="tmode" id="mTag">PRACTICE</span>
  <button class="tback" onclick="menu()">‹ MENU</button>
</div>

<!-- HINT -->
<div class="hint" id="hintBar">Right-Click Move · Q / Shift+Q / W / E / R</div>

<!-- ROUND BANNER -->
<div id="roundBanner" style="display:none;position:fixed;top:4px;left:50%;transform:translateX(-50%);z-index:45;text-align:center;background:rgba(10,20,40,.75);padding:4px 16px 6px;border-radius:6px;border:1px solid rgba(244,143,177,.2);">
  <div style="display:flex;align-items:center;gap:12px;justify-content:center;">
    <button onclick="skipRound(-1)" style="background:rgba(200,170,110,.15);border:1px solid rgba(200,170,110,.3);color:#f0e6d2;font:bold 14px Orbitron;padding:4px 12px;cursor:pointer;border-radius:4px;">◀ PREV</button>
    <div id="rbTitle" style="font:bold 16px Orbitron;color:#f48fb1;text-shadow:0 0 12px #e84393,0 0 24px rgba(232,67,147,.4);letter-spacing:2px;min-width:280px;"></div>
    <button onclick="skipRound(1)" style="background:rgba(200,170,110,.15);border:1px solid rgba(200,170,110,.3);color:#f0e6d2;font:bold 14px Orbitron;padding:4px 12px;cursor:pointer;border-radius:4px;">NEXT ▶</button>
  </div>
  <div id="rbDesc" style="font:12px Rajdhani;color:rgba(240,230,210,.7);margin-top:3px;max-width:500px;pointer-events:none;"></div>
</div>

<!-- BOTTOM HUD -->
<div class="bhud">
  <!-- LEFT: Abilities -->
  <div class="bhud-left">
    <div class="abslot rdy" id="sQ" onclick="castQ()"><span class="akey" id="qKey">Q</span><span class="aname" id="qName">Listen</span><div class="acost m" id="qCost"></div></div>
    <div class="abslot rdy" id="sW" onclick="cast('W')"><span class="akey">W</span><span class="aname">Stage</span><div class="acost fr"></div></div>
    <div class="abslot rdy" id="sE" onclick="cast('E')"><span class="akey">E</span><span class="aname">Beat</span><div class="acost m"></div></div>
    <div class="abslot" id="sR" onclick="cast('R')"><span class="akey">R</span><span class="aname">Ult</span><div class="acost en"></div></div>
  </div>

  <!-- CENTER: Portrait + Resources -->
  <div class="bhud-center">
    <div class="champ-frame"><canvas id="champIcon" width="58" height="58"></canvas><div class="champ-lvl">9</div></div>
    <div class="res-stack">
      <div class="rbar"><div class="rfill hp" id="hpF" style="width:100%"></div><span class="rlbl">HP</span><span class="rval" id="hpV">800 / 800</span></div>
      <div class="rbar"><div class="rfill mp" id="mpF" style="width:100%"></div><span class="rlbl">MANA</span><span class="rval" id="mpV">500 / 500</span></div>
      <div class="rbar"><div class="rfill ep" id="epF" style="width:0%"></div><span class="rlbl">ENERGY</span><span class="rval" id="epV">0 / 3</span><div class="emarks"><span></span><span></span><span></span></div></div>
    </div>
    <div class="pg-stack">
      <div class="passive-b dm" id="passB">DAMPENER</div>
      <div class="guard-row"><div class="gg dn" id="g0"></div><div class="gg dn" id="g1"></div><div class="gg dn" id="g2"></div></div>
      <div class="guard-lbl">GUARDS</div>
    </div>
  </div>

  <!-- RIGHT: Demo buttons / info -->
  <div class="bhud-right" id="bhudR"></div>
</div>

<!-- ABILITY DESCRIPTIONS SIDE PANEL -->
<div id="abilPanel">
  <div class="ap-title">Ability Kit</div>

  <div class="ap-resource">
    <div class="ap-resource-t">Dual Resource System</div>
    <div class="ap-resource-d"><b>Mana</b> (left bar) fuels Q1 and E — always available. <b>Energy</b> (right bar, 3 segments) fuels Q2 and R — only gained when guards fall. She must endure damage to unlock her strongest abilities.</div>
  </div>

  <div class="ap-ab" id="apP">
    <div class="ap-ab-head"><div class="ap-ab-key passive">P</div><div class="ap-ab-name">Dampener / Amplifier</div></div>
    <div class="ap-ab-desc"><b>Off stage:</b> Dampener mode — reduced range, passively reduces enemy ability effectiveness nearby. <b>On stage:</b> Amplifier mode — increased range, next basic ability echoes (casts twice).</div>
    <div class="ap-ab-lore">Her parents crafted a dampener to repress her powers. She dismantled it and gave the crystal a new home — a platform that amplifies her gifts.</div>
  </div>

  <div class="ap-ab" id="apQ">
    <div class="ap-ab-head"><div class="ap-ab-key q">Q</div><div class="ap-ab-name">Listen / Speak</div><div class="ap-ab-cost">Q1: MANA · Q2: ENERGY</div></div>
    <div class="ap-ab-desc"><b>Q1 — Listen</b> <span class="tag-mana">MANA</span>: Wide area burst dealing <b>max HP damage</b>. Applies <b>Soul Read</b> — reveals all enemy ability cooldowns. Easy to land for scouting and poking.<br><b>Q2 — Speak</b> <span class="tag-energy">ENERGY</span>: Pinpoint area dealing <b>missing HP burst</b>. Applies <b>Tempo Break</b> — reduces enemy ability haste. Demands precision aim. Enemies under R take amplified damage.</div>
    <div class="ap-ab-lore">"She heard every person's soul, loving or cruel." Q1 reads them. Q2 disrupts them. Listen first, endure, then speak.</div>
  </div>

  <div class="ap-ab" id="apW">
    <div class="ap-ab-head"><div class="ap-ab-key w">W</div><div class="ap-ab-name">Set the Stage</div><div class="ap-ab-cost">FREE</div></div>
    <div class="ap-ab-desc"><span class="tag-free">NO COST</span> — Press up to 3 times. Each places a <b>stage</b> with its own <b>guard</b>. Guards absorb damage while Sera stands on the stage. When a guard falls: <b>+1 Energy</b>. Stages persist until guard breaks. If Sera dies, all remaining guards break and grant energy for respawn.</div>
    <div class="ap-ab-lore">"Why can't they put their guards down for one moment?" Guards must come down for something real to happen — and when they do, she gains her power.</div>
  </div>

  <div class="ap-ab" id="apE">
    <div class="ap-ab-head"><div class="ap-ab-key e">E</div><div class="ap-ab-name">Beat Drop</div><div class="ap-ab-cost">MANA</div></div>
    <div class="ap-ab-desc"><span class="tag-mana">MANA</span> — Soundwave in a line dealing <b>magic damage</b> and <b>shattering enemy shields</b>. Always available as part of her proactive trading kit alongside Q1.</div>
    <div class="ap-ab-lore">Her arc is about dismantling barriers — the dampener, the divide between cities. An ability that strips shields fits breaking through so people can truly be heard.</div>
  </div>

  <div class="ap-ab" id="apR">
    <div class="ap-ab-head"><div class="ap-ab-key r">R</div><div class="ap-ab-name">Cover Your Ears</div><div class="ap-ab-cost">ENERGY ×2</div></div>
    <div class="ap-ab-desc"><span class="tag-energy">ENERGY</span> — Massive soundwave that <b>silences</b> enemies and <b>reduces healing</b>. Deals <b>no damage</b>. Resets travel distance on champion hit. Enemies affected take <b>increased damage from Q1 and Q2</b>. If enemy dies to Q2 while silenced, <b>one guard cooldown refreshes</b>.</div>
    <div class="ap-ab-lore">She hid shivering, hands over her ears, unable to hear herself above the chaos. Now her music is so powerful it forces enemies to cover theirs.</div>
  </div>
</div>
</div>

<div class="rspn" id="rbar">RESPAWNING...</div>

<script>
// ═══════════════════════════════════════════════════════════
//  SERA REWORK KIT CONCEPT GAME — by JLTHAKAD
// ═══════════════════════════════════════════════════════════
const cv=document.getElementById('c'),cx=cv.getContext('2d');
// Safe arc wrapper — prevents negative radius errors
const _origArc=CanvasRenderingContext2D.prototype.arc;
CanvasRenderingContext2D.prototype.arc=function(x,y,r,...a){return _origArc.call(this,x,y,Math.max(0,r),...a);};
const _origRG=CanvasRenderingContext2D.prototype.createRadialGradient;
CanvasRenderingContext2D.prototype.createRadialGradient=function(x0,y0,r0,x1,y1,r1){return _origRG.call(this,x0,y0,Math.max(0,r0),x1,y1,Math.max(0,r1));};
// roundRect polyfill
if(!CanvasRenderingContext2D.prototype.roundRect){CanvasRenderingContext2D.prototype.roundRect=function(x,y,w,h,r){r=typeof r==='number'?r:0;this.moveTo(x+r,y);this.lineTo(x+w-r,y);this.arcTo(x+w,y,x+w,y+r,r);this.lineTo(x+w,y+h-r);this.arcTo(x+w,y+h,x+w-r,y+h,r);this.lineTo(x+r,y+h);this.arcTo(x,y+h,x,y+h-r,r);this.lineTo(x,y+r);this.arcTo(x,y,x+r,y,r);this.closePath();};}
const _origEll=CanvasRenderingContext2D.prototype.ellipse;
CanvasRenderingContext2D.prototype.ellipse=function(x,y,rx,ry,...a){return _origEll.call(this,x,y,Math.max(0,rx),Math.max(0,ry),...a);};
let W,H,dpr;
function resize(){dpr=devicePixelRatio||1;W=innerWidth;H=innerHeight;cv.width=W*dpr;cv.height=H*dpr;cx.setTransform(dpr,0,0,dpr,0,0);}
addEventListener('resize',resize);resize();

let mode=null,run=false,raf=null,lt=0,moveTo=null,mx=0,my=0;
const G={s:null,en:[],stg:[],proj:[],fx:[],tur:null,etur:null,t:0,
  dQ:[],dT:0,dOn:false,jT:0,jI:22,jA:false,jk:null,_dMov:null};

// ═══ FACTORIES ═══
function mkS(x,y){return{x:x||W/2,y:y||H*.55,spd:210,r:18,hp:800,mhp:800,mn:500,mmn:500,en:0,men:3,onS:null,amp:false,_prevAmp:false,ecR:false,ecU:false,gcd:[0,0,0],alive:true,cd:{Q:0,W:0,E:0,R:0},cdm:{Q1:3.5,Q2:5.5,W:1,E:4.5,R:14},mc:{Q1:60,E:50},ec:{Q2:1,R:2},rng:220,arng:320,dA:1,inv:0,trail:[],qPhase:0,qRecast:0,qRecastMax:3.5};}
function mkE(x,y,o={}){
  // Dummy ability kit — each has cd, maxCd, name, color
  const dab=o.dab||{
    Q:{cd:0,mcd:3.2,name:'Bolt',col:'#ef5350',desc:'Skillshot'},
    W:{cd:0,mcd:8,name:'Barrier',col:'#00e5ff',desc:'Shield'},
    E:{cd:0,mcd:10,name:'Drain',col:'#66bb6a',desc:'Heal'},
    R:{cd:0,mcd:20,name:'Unleash',col:'#ffa726',desc:'Big Burst'}
  };
  return{x,y,spd:o.spd||0,r:20,hp:o.hp||600,mhp:o.hp||600,sh:0,msh:o.msh||160,sht:Math.random()*3,shi:o.shi||6,at:0,ai:o.ai||2.2,ad:o.ad||42,ar:o.ar||240,chase:o.chase||false,heal:o.heal||false,ht:0,hi:4,ha:30,si:0,ah:0,rA:0,tb:0,sr:0,alive:true,col:o.col||'#c62828',lbl:o.lbl||'Dummy',dt:0,rt:o.rt||8,sx:o.sx||x,sy:o.sy||y,jnk:o.jnk||false,_st:0,
  dab, // dummy abilities
  pace:o.pace||false,paceXMin:o.paceXMin||(x-60),paceXMax:o.paceXMax||(x+60),paceYMin:o.paceYMin||(y-30),paceYMax:o.paceYMax||(y+30),paceSpd:o.paceSpd||55,paceTgt:null,paceWait:0};
}
function mkStg(x,y,gi){return{x,y,r:55,gi,gh:100,gmh:100,act:true};}
function mkP(tp,x,y,tx,ty,d={}){const dx=tx-x,dy=ty-y,di=Math.hypot(dx,dy)||1;return{tp,x,y,tx,ty,dx:dx/di,dy:dy/di,a:0,li:d.li||1,sp:d.sp||450,r:d.r||10,dmg:d.dmg||0,hit:false,d};}

// ═══ FX ═══
function burst(x,y,c,n=10,sp=80,li=.5,sz=3){for(let i=0;i<n;i++){const a=Math.random()*Math.PI*2,s=20+Math.random()*sp;G.fx.push({t:'p',x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,li,a:0,c,sz:sz*(.5+Math.random())});}}
function ring(x,y,c,mr=80,li=.5){G.fx.push({t:'r',x,y,c,mr,li,a:0});}
function ftxt(x,y,tx,c='#fff',sz=16){G.fx.push({t:'t',x,y,tx,c,sz,a:0,li:.9});}
function swave(x,y,dx,dy,c,n=5){const ba=Math.atan2(dy,dx);for(let i=0;i<n;i++){const a=ba+(-.3+.6*i/(n-1));G.fx.push({t:'w',x,y,ang:a,c,a:0,li:.5,sp:280+i*30});}}
function nburst(x,y,n=5){const ns=['♪','♫','♬','♩'];const cs=['#e84393','#f48fb1','#ce93d8','#ffd700','#ba68c8'];for(let i=0;i<n;i++){const a=Math.random()*Math.PI*2,s=40+Math.random()*60;G.fx.push({t:'n',x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s-30,no:ns[i%4],a:0,li:.8+Math.random()*.4,c:cs[i%5]});}}

// ═══ DRAW SERA ═══
function drawSera(s,t){
  const{x,y,r,amp}=s;cx.save();cx.translate(x,y);
  cx.fillStyle='rgba(0,0,0,.2)';cx.beginPath();cx.ellipse(0,r*.6,r*.8,r*.3,0,0,Math.PI*2);cx.fill();
  if(amp){for(let i=3;i>=0;i--){cx.globalAlpha=.035+i*.015;const ag=cx.createRadialGradient(0,0,r,0,0,r*3.5+Math.sin(t*3)*6-i*10);ag.addColorStop(0,'#e84393');ag.addColorStop(.5,'#c44dff');ag.addColorStop(1,'transparent');cx.fillStyle=ag;cx.beginPath();cx.arc(0,0,r*3.5-i*10,0,Math.PI*2);cx.fill();}cx.globalAlpha=1;for(let i=0;i<3;i++){const a=t*2+i*2.1,nr=r*2+Math.sin(t*1.5+i)*12;cx.globalAlpha=.3+Math.sin(t*3+i)*.2;cx.fillStyle='#f48fb1';cx.font='13px serif';cx.textAlign='center';cx.fillText(['♪','♫','♬'][i],Math.cos(a)*nr,Math.sin(a)*nr-8);}cx.globalAlpha=1;}
  else{cx.globalAlpha=.07;cx.strokeStyle='#4fc3f7';cx.lineWidth=1;cx.setLineDash([3,5]);cx.beginPath();cx.arc(0,0,r*2.3,0,Math.PI*2);cx.stroke();cx.setLineDash([]);cx.globalAlpha=1;}
  const hw=Math.sin(t*2)*3;
  cx.fillStyle='#f48fb1';cx.beginPath();cx.moveTo(-r*.7,-r*.3);cx.quadraticCurveTo(-r*1.1-hw,-r*.7,-r-hw,r*.7);cx.quadraticCurveTo(-r*.7,r*.4,-r*.4,0);cx.fill();
  cx.beginPath();cx.moveTo(r*.5,-r*.5);cx.quadraticCurveTo(r*1.2+hw,-r*.2,r*1.1+hw,r*.9);cx.quadraticCurveTo(r*.7,r*.5,r*.3,0);cx.fill();
  cx.fillStyle='#ec407a';cx.beginPath();cx.moveTo(-r*.3,0);cx.quadraticCurveTo(-r*.4+hw*.5,r*1.4,0,r*2+Math.sin(t*1.5)*3);cx.quadraticCurveTo(r*.3,r*1.6,r*.2,r*.3);cx.fill();
  const dg=cx.createLinearGradient(0,-r,0,r*1.3);dg.addColorStop(0,amp?'#e84393':'#7e57c2');dg.addColorStop(.5,amp?'#c44dff':'#5c6bc0');dg.addColorStop(1,amp?'#9c27b0':'#3949ab');
  cx.fillStyle=dg;cx.beginPath();cx.moveTo(-r*.5,-r*.2);cx.quadraticCurveTo(-r*.65,r*.5,-r*.85,r*1.2);cx.lineTo(r*.85,r*1.2);cx.quadraticCurveTo(r*.65,r*.5,r*.5,-r*.2);cx.closePath();cx.fill();
  cx.fillStyle=amp?'#f8bbd0':'#b39ddb';cx.beginPath();cx.ellipse(0,-r*.1,r*.45,r*.5,0,0,Math.PI*2);cx.fill();
  const sk=cx.createRadialGradient(-1,-r*.55,1,0,-r*.5,r*.4);sk.addColorStop(0,'#fce4ec');sk.addColorStop(1,'#f8bbd0');cx.fillStyle=sk;cx.beginPath();cx.arc(0,-r*.55,r*.38,0,Math.PI*2);cx.fill();
  if(Math.abs(Math.sin(t*.5))>.05){cx.fillStyle='#4a148c';cx.beginPath();cx.ellipse(-r*.13,-r*.58,2.5,3,0,0,Math.PI*2);cx.fill();cx.beginPath();cx.ellipse(r*.09,-r*.58,2.5,3,0,0,Math.PI*2);cx.fill();cx.fillStyle='#fff';cx.beginPath();cx.arc(-r*.11,-r*.61,1,0,Math.PI*2);cx.fill();cx.beginPath();cx.arc(r*.11,-r*.61,1,0,Math.PI*2);cx.fill();}
  else{cx.strokeStyle='#4a148c';cx.lineWidth=1.5;cx.beginPath();cx.moveTo(-r*.2,-r*.58);cx.lineTo(-r*.06,-r*.58);cx.stroke();cx.beginPath();cx.moveTo(r*.03,-r*.58);cx.lineTo(r*.15,-r*.58);cx.stroke();}
  cx.strokeStyle='#c2185b';cx.lineWidth=1;cx.beginPath();cx.arc(0,-r*.44,2.5,.2,Math.PI-.2);cx.stroke();
  const aw=Math.sin(t*3)*7;cx.strokeStyle=amp?'#f8bbd0':'#b39ddb';cx.lineWidth=3.5;cx.lineCap='round';
  cx.beginPath();cx.moveTo(-r*.45,0);cx.quadraticCurveTo(-r,-r*.3+aw,-r*.9,r*.2+aw);cx.stroke();
  cx.beginPath();cx.moveTo(r*.45,0);cx.quadraticCurveTo(r,-r*.4-aw,r*.85,-r*.15-aw);cx.stroke();
  if(amp){cx.globalAlpha=.4;cx.fillStyle='#e84393';cx.beginPath();cx.arc(-r*.9,r*.2+aw,4,0,Math.PI*2);cx.fill();cx.beginPath();cx.arc(r*.85,-r*.15-aw,4,0,Math.PI*2);cx.fill();cx.globalAlpha=1;}
  if(s.ecR&&!s.ecU){cx.strokeStyle='rgba(244,143,177,.5)';cx.lineWidth=1.5;cx.beginPath();cx.arc(0,0,r*1.7+Math.sin(t*5)*3,0,Math.PI*2);cx.stroke();}
  cx.restore();
  const bw=40,bh=4,bx=x-bw/2,by=y-r*2.5-12;cx.fillStyle='#1e2328';cx.fillRect(bx-1,by-1,bw+2,bh+2);const hr=s.hp/s.mhp;cx.fillStyle=hr>.5?'#2faf3f':hr>.25?'#ffa726':'#ef5350';cx.fillRect(bx,by,bw*hr,bh);cx.strokeStyle='#5b5a56';cx.lineWidth=1;cx.strokeRect(bx-1,by-1,bw+2,bh+2);
  cx.fillStyle='#f0e6d2';cx.font='bold 10px Rajdhani';cx.textAlign='center';cx.fillText('Sera Rework',x,by-3);
  if(s.inv>0&&Math.floor(t*10)%2===0){cx.save();cx.globalAlpha=.2;cx.fillStyle='#fff';cx.beginPath();cx.arc(x,y,r+5,0,Math.PI*2);cx.fill();cx.restore();}
}
function drawEn(d,t){
  if(!d.alive){if(!d.ktgt){const rem=Math.max(0,d.rt-d.dt);if(rem>0){cx.globalAlpha=.3;cx.fillStyle='#5b5a56';cx.font='11px Orbitron';cx.textAlign='center';cx.fillText(`${Math.ceil(rem)}s`,d.sx,d.sy);cx.globalAlpha=1;}}return;}
  // ─── KITE AIM TARGETS — custom rendering ───
  if(d.ktgt){
    const r=d.r;const life=d.klife>0?(1-d.kage/d.klife):1;
    cx.save();cx.translate(d.x,d.y);
    // Pulsing glow
    cx.globalAlpha=.15+Math.sin(t*4)*.05;
    const g=cx.createRadialGradient(0,0,r*.3,0,0,r*2);
    g.addColorStop(0,d.col);g.addColorStop(1,'transparent');
    cx.fillStyle=g;cx.beginPath();cx.arc(0,0,r*2,0,Math.PI*2);cx.fill();
    cx.globalAlpha=1;
    // Outer ring (fades as time runs out)
    cx.strokeStyle=d.col;cx.lineWidth=2;cx.globalAlpha=.3+life*.4;
    cx.beginPath();cx.arc(0,0,r+4,0,Math.PI*2);cx.stroke();
    // Life timer arc
    cx.lineWidth=3;cx.globalAlpha=.8;cx.strokeStyle=life>.4?d.col:'#ef5350';
    cx.beginPath();cx.arc(0,0,r+4,-Math.PI/2,-Math.PI/2+Math.PI*2*life);cx.stroke();
    cx.globalAlpha=1;
    // Filled circle
    const bg=cx.createRadialGradient(0,0,0,0,0,r);
    bg.addColorStop(0,'rgba(255,255,255,.15)');bg.addColorStop(.6,d.col);bg.addColorStop(1,d.col);
    cx.fillStyle=bg;cx.beginPath();cx.arc(0,0,r,0,Math.PI*2);cx.fill();
    // Inner crosshair
    cx.strokeStyle='rgba(255,255,255,.5)';cx.lineWidth=1;
    cx.beginPath();cx.moveTo(-r*.5,0);cx.lineTo(r*.5,0);cx.stroke();
    cx.beginPath();cx.moveTo(0,-r*.5);cx.lineTo(0,r*.5);cx.stroke();
    cx.beginPath();cx.arc(0,0,r*.35,0,Math.PI*2);cx.stroke();
    // Shield ring (for shield targets)
    if(d.sh>0){cx.strokeStyle='#00e5ff';cx.lineWidth=3;cx.globalAlpha=.6+Math.sin(t*6)*.2;cx.beginPath();cx.arc(0,0,r+8,0,Math.PI*2);cx.stroke();cx.globalAlpha=1;}
    // R-required ring (for r_tgt before silenced)
    if(d.ktgt==='r_tgt'&&d.rA<=0){cx.strokeStyle='#aa00ff';cx.lineWidth=2;cx.setLineDash([4,4]);cx.globalAlpha=.5+Math.sin(t*5)*.2;cx.beginPath();cx.arc(0,0,r+8,0,Math.PI*2);cx.stroke();cx.setLineDash([]);cx.globalAlpha=1;}
    // Silenced indicator
    if(d.rA>0){cx.strokeStyle='#ff1744';cx.lineWidth=2.5;cx.globalAlpha=.6;cx.beginPath();cx.arc(0,0,r+8,0,Math.PI*2);cx.stroke();cx.globalAlpha=1;}
    cx.restore();
    // Label — large, color-matched with dark background pill
    cx.font='bold 12px Orbitron';cx.textAlign='center';
    const lblW=cx.measureText(d.lbl).width+10;
    cx.fillStyle='rgba(1,10,19,.7)';
    cx.beginPath();cx.roundRect(d.x-lblW/2,d.y-r-24,lblW,16,3);cx.fill();
    cx.fillStyle=d.col;cx.fillText(d.lbl,d.x,d.y-r-12);
    return;
  }
  cx.save();cx.translate(d.x,d.y);const r=d.r;
  cx.fillStyle='rgba(0,0,0,.15)';cx.beginPath();cx.ellipse(0,r*.5,r*.7,r*.2,0,0,Math.PI*2);cx.fill();
  if(d.si>0){cx.globalAlpha=.25+Math.sin(t*8)*.1;const sg=cx.createRadialGradient(0,0,r,0,0,r*2.2);sg.addColorStop(0,'#aa00ff');sg.addColorStop(1,'transparent');cx.fillStyle=sg;cx.beginPath();cx.arc(0,0,r*2.2,0,Math.PI*2);cx.fill();cx.globalAlpha=1;}
  if(d.rA>0){cx.strokeStyle='rgba(255,23,68,.35)';cx.lineWidth=2;cx.beginPath();cx.arc(0,0,r+9+Math.sin(t*4)*2,0,Math.PI*2);cx.stroke();}
  const bg=cx.createRadialGradient(-2,-3,2,0,0,r);bg.addColorStop(0,'#ef9a9a');bg.addColorStop(1,d.col);cx.fillStyle=bg;
  cx.beginPath();cx.moveTo(0,-r);cx.quadraticCurveTo(r*.8,-r*.8,r*.6,-r*.2);cx.lineTo(r*.7,r*.4);cx.quadraticCurveTo(r*.5,r,0,r*1.1);cx.quadraticCurveTo(-r*.5,r,-r*.7,r*.4);cx.lineTo(-r*.6,-r*.2);cx.quadraticCurveTo(-r*.8,-r*.8,0,-r);cx.fill();
  cx.fillStyle=d.jnk?'#e65100':'#b71c1c';cx.beginPath();cx.arc(0,-r*.75,r*.32,0,Math.PI*2);cx.fill();
  cx.strokeStyle='#fff';cx.lineWidth=1;cx.globalAlpha=.2;cx.beginPath();cx.arc(0,0,r*.4,0,Math.PI*2);cx.stroke();cx.beginPath();cx.moveTo(-r*.25,0);cx.lineTo(r*.25,0);cx.stroke();cx.beginPath();cx.moveTo(0,-r*.25);cx.lineTo(0,r*.25);cx.stroke();cx.globalAlpha=1;
  if(d.sh>0){const sr=d.sh/d.msh;cx.strokeStyle='#00e5ff';cx.lineWidth=3;cx.globalAlpha=.55+Math.sin(t*6)*.15;cx.beginPath();cx.arc(0,0,r+7,0,Math.PI*2*sr);cx.stroke();cx.globalAlpha=.1;cx.fillStyle='#00e5ff';cx.beginPath();cx.arc(0,0,r+5,0,Math.PI*2);cx.fill();cx.globalAlpha=1;}
  cx.restore();
  // ─── HP bar ───
  const bw=40,bh=4,bx=d.x-bw/2,by=d.y-d.r*1.8-14;cx.fillStyle='#1e2328';cx.fillRect(bx-1,by-1,bw+2,bh+2);
  if(d.sh>0){cx.fillStyle='#00838f';cx.fillRect(bx,by,bw*(d.sh/d.msh),bh);}
  cx.fillStyle='#c62828';cx.fillRect(bx,by,bw*Math.max(0,d.hp/d.mhp),bh);cx.strokeStyle='#5b5a56';cx.lineWidth=1;cx.strokeRect(bx-1,by-1,bw+2,bh+2);
  let ly=by-4;cx.font='bold 10px Rajdhani';cx.textAlign='center';cx.fillStyle=d.jnk?'#ff9800':'#ef9a9a';cx.fillText(d.lbl,d.x,ly);ly-=10;
  if(d.si>0){cx.fillStyle='#aa00ff';cx.font='bold 8px Orbitron';cx.fillText('SILENCED',d.x,ly);ly-=10;}
  if(d.ah>0){cx.fillStyle='#ef5350';cx.font='8px Orbitron';cx.fillText('ANTI-HEAL',d.x,ly);ly-=10;}
  if(d.tb>0){cx.fillStyle='#ffb74d';cx.font='8px Orbitron';cx.fillText('TEMPO BREAK −55% HASTE',d.x,ly);ly-=10;}
  if(d.rA>0){cx.fillStyle='rgba(255,23,68,.5)';cx.font='7px Orbitron';cx.fillText('+35% DMG',d.x,d.y+d.r+14);}
  // ─── ABILITY COOLDOWN PANEL — visible during Soul Read or Tempo Break ───
  if((d.sr>0||d.tb>0)&&d.dab){
    const isTB=d.tb>0;
    const keys=['Q','W','E','R'];
    const pw=120,ph=keys.length*18+8;
    const px=d.x+d.r+22,py=d.y-ph/2;
    // Panel background
    cx.fillStyle=isTB?'rgba(255,183,77,.08)':'rgba(144,202,249,.08)';
    cx.strokeStyle=isTB?'rgba(255,183,77,.35)':'rgba(144,202,249,.35)';
    cx.lineWidth=1;cx.beginPath();
    cx.roundRect(px-4,py-4,pw+8,ph+8,3);cx.fill();cx.stroke();
    // Header
    cx.font='bold 7px Orbitron';cx.textAlign='left';
    cx.fillStyle=isTB?'#ffb74d':'#90caf9';
    cx.fillText(isTB?'TEMPO BREAK':'SOUL READ',px,py+5);
    if(isTB){cx.fillStyle='#ef5350';cx.fillText('  −55% CD RATE',px+58,py+5);}
    // Each ability row
    for(let i=0;i<keys.length;i++){
      const k=keys[i];const ab=d.dab[k];
      const ry=py+12+i*18;
      const onCD=ab.cd>0;
      const cdPct=onCD?ab.cd/ab.mcd:0;
      // Key letter
      cx.fillStyle=ab.col;cx.font='bold 11px Orbitron';cx.textAlign='left';
      cx.fillText(k,px,ry+11);
      // Ability name
      cx.fillStyle=onCD?'#5b5a56':'#f0e6d2';cx.font='9px Rajdhani';
      cx.fillText(ab.name,px+14,ry+11);
      // CD bar background
      const barX=px+50,barW=50,barH=8;
      cx.fillStyle='rgba(30,35,40,.7)';cx.fillRect(barX,ry+3,barW,barH);
      if(onCD){
        // CD remaining fill
        cx.fillStyle=isTB?'rgba(255,183,77,.5)':'rgba(144,202,249,.4)';
        cx.fillRect(barX,ry+3,barW*cdPct,barH);
        // CD number
        cx.fillStyle=isTB?'#ffb74d':'#90caf9';cx.font='bold 8px Orbitron';cx.textAlign='right';
        cx.fillText(ab.cd.toFixed(1)+'s',px+pw,ry+11);
      }else{
        // READY
        cx.fillStyle='#2faf3f';cx.fillRect(barX,ry+3,barW,barH);
        cx.fillStyle='#a5d6a7';cx.font='bold 7px Orbitron';cx.textAlign='center';
        cx.fillText('READY',barX+barW/2,ry+10);
      }
      cx.textAlign='left';
    }
  }
  // Soul Read label (when no panel drawn — sr active but no dab)
  else if(d.sr>0&&!d.dab){
    cx.fillStyle='rgba(144,202,249,.4)';cx.font='8px Orbitron';cx.textAlign='center';cx.fillText('SOUL READ',d.x,ly);
  }
}
function drawStg(st,t){
  if(!st.act)return;const{x,y,r,gh,gmh,gi}=st;const p=.7+Math.sin(t*2+gi*2)*.3;
  cx.save();for(let i=3;i>=0;i--){cx.globalAlpha=(.05+i*.02)*p;const g=cx.createRadialGradient(x,y,0,x,y,r+i*6);g.addColorStop(0,'#daa520');g.addColorStop(.4,'#e84393');g.addColorStop(1,'transparent');cx.fillStyle=g;cx.beginPath();cx.arc(x,y,r+i*6,0,Math.PI*2);cx.fill();}cx.restore();
  cx.strokeStyle=`rgba(218,165,32,${.3*p})`;cx.lineWidth=1.5;cx.beginPath();cx.arc(x,y,r,0,Math.PI*2);cx.stroke();
  cx.save();cx.globalAlpha=.06*p;cx.strokeStyle='#ffd700';cx.lineWidth=1;for(let i=0;i<6;i++){const a=i*Math.PI/3+t*.4;cx.beginPath();cx.moveTo(x,y);cx.lineTo(x+Math.cos(a)*r*.6,y+Math.sin(a)*r*.6);cx.stroke();}cx.restore();
  for(let i=0;i<3;i++){const a=t*1.2+i*2.1,fr=r*.75;cx.globalAlpha=.2*p;cx.fillStyle='#ffd700';cx.font='10px serif';cx.textAlign='center';cx.fillText('♪',x+Math.cos(a)*fr,y+Math.sin(a)*fr);}cx.globalAlpha=1;
  const gr=gh/gmh,bw=30;cx.fillStyle='rgba(0,0,0,.3)';cx.fillRect(x-bw/2,y+r+3,bw,3);cx.fillStyle=gr>.5?'#ffd700':'#ff8a80';cx.fillRect(x-bw/2,y+r+3,bw*gr,3);
}
function drawTur(tu){
  cx.strokeStyle='rgba(200,170,110,.06)';cx.lineWidth=1;cx.setLineDash([6,10]);cx.beginPath();cx.arc(tu.x,tu.y,tu.rng,0,Math.PI*2);cx.stroke();cx.setLineDash([]);
  cx.fillStyle='#1e2328';cx.beginPath();cx.arc(tu.x,tu.y,tu.r,0,Math.PI*2);cx.fill();cx.strokeStyle='#c8aa6e';cx.lineWidth=2.5;cx.beginPath();cx.arc(tu.x,tu.y,tu.r,0,Math.PI*2);cx.stroke();
  const ig=cx.createRadialGradient(tu.x,tu.y,0,tu.x,tu.y,tu.r*.5);ig.addColorStop(0,'#ffd700');ig.addColorStop(1,'#c8aa6e');cx.fillStyle=ig;cx.beginPath();cx.arc(tu.x,tu.y,tu.r*.35,0,Math.PI*2);cx.fill();
  cx.fillStyle='#c8aa6e';cx.beginPath();cx.moveTo(tu.x-3,tu.y-tu.r);cx.lineTo(tu.x+3,tu.y-tu.r);cx.lineTo(tu.x,tu.y-tu.r-14);cx.fill();
}
function drawETur(et){
  cx.strokeStyle='rgba(255,50,50,.06)';cx.lineWidth=1;cx.setLineDash([6,10]);cx.beginPath();cx.arc(et.x,et.y,et.rng,0,Math.PI*2);cx.stroke();cx.setLineDash([]);
  cx.fillStyle='#1e2328';cx.beginPath();cx.arc(et.x,et.y,et.r,0,Math.PI*2);cx.fill();cx.strokeStyle='#c62828';cx.lineWidth=2.5;cx.beginPath();cx.arc(et.x,et.y,et.r,0,Math.PI*2);cx.stroke();
  const ig=cx.createRadialGradient(et.x,et.y,0,et.x,et.y,et.r*.5);ig.addColorStop(0,'#ef5350');ig.addColorStop(1,'#c62828');cx.fillStyle=ig;cx.beginPath();cx.arc(et.x,et.y,et.r*.35,0,Math.PI*2);cx.fill();
  cx.fillStyle='#c62828';cx.beginPath();cx.moveTo(et.x-3,et.y+et.r);cx.lineTo(et.x+3,et.y+et.r);cx.lineTo(et.x,et.y+et.r+14);cx.fill();
}

// ═══ CHAMPION ICON ═══
function drawChampIcon(){const ic=document.getElementById('champIcon').getContext('2d');ic.fillStyle='#0a1428';ic.fillRect(0,0,58,58);ic.fillStyle='#f8bbd0';ic.beginPath();ic.arc(29,26,13,0,Math.PI*2);ic.fill();ic.fillStyle='#f48fb1';ic.beginPath();ic.moveTo(15,18);ic.quadraticCurveTo(7,10,11,33);ic.quadraticCurveTo(17,26,19,20);ic.fill();ic.beginPath();ic.moveTo(43,18);ic.quadraticCurveTo(51,10,47,33);ic.quadraticCurveTo(41,26,39,20);ic.fill();ic.fillStyle='#4a148c';ic.beginPath();ic.arc(24,24,2.5,0,Math.PI*2);ic.fill();ic.beginPath();ic.arc(34,24,2.5,0,Math.PI*2);ic.fill();ic.fillStyle='#fff';ic.beginPath();ic.arc(23,23,1,0,Math.PI*2);ic.fill();ic.beginPath();ic.arc(33,23,1,0,Math.PI*2);ic.fill();const dg2=ic.createLinearGradient(19,36,39,54);dg2.addColorStop(0,'#e84393');dg2.addColorStop(1,'#9c27b0');ic.fillStyle=dg2;ic.beginPath();ic.moveTo(17,36);ic.quadraticCurveTo(13,53,23,56);ic.lineTo(35,56);ic.quadraticCurveTo(45,53,41,36);ic.closePath();ic.fill();}

// ═══ CAST ═══
function near(s){let b=null,bd=1e9;for(const d of G.en){if(!d.alive)continue;const di=Math.hypot(d.x-s.x,d.y-s.y);if(di<bd){bd=di;b=d;}}return b;}
// ═══ Q RECAST (Akali R1/R2 style) ═══
// qPhase: 0 = ready for Q1, 1 = Q1 fired, waiting for Q2 recast
// qRecast: countdown timer for the recast window
function castQ(){
  if(G.dOn&&mode==='demo')return;
  const s=G.s;if(!s||!s.alive)return;
  const isKite=mode==='kite'&&G.kite;
  if(isKite){
    // Kite mode: no CD, no cost, no recast. Q always fires at cursor.
    const tx=mx,ty=my;
    const p=mkP('Q1',s.x,s.y,tx,ty,{li:.55,sp:550,r:s.amp?85:65,dmg:85});
    p._kh=false;G.proj.push(p);
    burst(s.x,s.y,'#e84393',8,45);nburst(s.x,s.y,3);swave(s.x,s.y,tx-s.x,ty-s.y,'#e84393',4);
    kiteFired();
    return;
  }
  if(s.qPhase===0){
    // Q1 — Listen (mana)
    if(s.cd.Q>0||s.mn<s.mc.Q1)return;
    s.mn-=s.mc.Q1;
    const tx=mx,ty=my;
    const p=mkP('Q1',s.x,s.y,tx,ty,{li:.55,sp:550,r:s.amp?85:65,dmg:85});
    p._kh=false;G.proj.push(p);
    burst(s.x,s.y,'#e84393',8,45);nburst(s.x,s.y,3);swave(s.x,s.y,tx-s.x,ty-s.y,'#e84393',4);
    doEc(s,'Q1',tx,ty);
    s.qPhase=1;s.qRecast=s.qRecastMax;
    if(mode==='kite'&&G.kite)kiteFired();
  }else if(s.qPhase===1){
    // Q2 — Speak (energy)
    if(s.en<s.ec.Q2)return;
    s.en-=s.ec.Q2;
    const tx=mx,ty=my;
    const p=mkP('Q2',s.x,s.y,tx,ty,{li:.5,sp:600,r:s.amp?38:28,dmg:140});
    p._kh=false;G.proj.push(p);
    burst(s.x,s.y,'#ffd700',10,55);swave(s.x,s.y,tx-s.x,ty-s.y,'#ffd700',3);
    doEc(s,'Q2',tx,ty);
    s.qPhase=0;s.qRecast=0;s.cd.Q=s.cdm.Q2;
    if(mode==='kite'&&G.kite)kiteFired();
  }
}
function doCastQ(){// force cast for demos
  const s=G.s;if(!s||!s.alive)return;
  if(s.qPhase===0){
    if(s.cd.Q>0||s.mn<s.mc.Q1)return;
    s.mn-=s.mc.Q1;
    const tgt=near(s);const tx=tgt?tgt.x:s.x,ty=tgt?tgt.y:s.y-100;
    G.proj.push(mkP('Q1',s.x,s.y,tx,ty,{li:.55,sp:550,r:s.amp?85:65,dmg:85}));
    burst(s.x,s.y,'#e84393',8,45);nburst(s.x,s.y,3);swave(s.x,s.y,tx-s.x,ty-s.y,'#e84393',4);
    doEc(s,'Q1',tx,ty);
    s.qPhase=1;s.qRecast=s.qRecastMax;
    hiAb('Q');
  }else if(s.qPhase===1){
    if(s.en<s.ec.Q2)return;
    s.en-=s.ec.Q2;
    const tgt=near(s);const tx=tgt?tgt.x:s.x,ty=tgt?tgt.y:s.y-100;
    G.proj.push(mkP('Q2',s.x,s.y,tx,ty,{li:.5,sp:600,r:s.amp?38:28,dmg:140}));
    burst(s.x,s.y,'#ffd700',10,55);swave(s.x,s.y,tx-s.x,ty-s.y,'#ffd700',3);
    doEc(s,'Q2',tx,ty);
    s.qPhase=0;s.qRecast=0;s.cd.Q=s.cdm.Q2;
    hiAb('Q');
  }
}
function cast(ab){if(G.dOn&&mode==='demo')return;const s=G.s;if(!s||!s.alive)return;
  const isKite=mode==='kite'&&G.kite;
  if(!isKite){if(s.cd[ab]>0)return;if(ab==='E'&&s.mn<s.mc.E)return;if(ab==='R'&&s.en<s.ec.R)return;}
  if(ab==='W'){let gi=-1;for(let i=0;i<3;i++){if(s.gcd[i]<=0&&!G.stg.find(st=>st.gi===i&&st.act)){gi=i;break;}}if(gi<0)return;G.stg.push(mkStg(s.x,s.y,gi));if(!isKite)s.cd.W=s.cdm.W;burst(s.x,s.y,'#ffd700',12,50,.5);nburst(s.x,s.y,3);return;}
  const tx=mx,ty=my;
  if(ab==='E'){if(!isKite){s.mn-=s.mc.E;s.cd.E=s.cdm.E;}const p=mkP('E',s.x,s.y,tx,ty,{li:1.2,sp:500,r:14,dmg:65});p._kh=false;G.proj.push(p);burst(s.x,s.y,'#2196f3',8,35);swave(s.x,s.y,tx-s.x,ty-s.y,'#2196f3',5);if(isKite)kiteFired();}
  else if(ab==='R'){if(!isKite){s.en-=s.ec.R;s.cd.R=s.cdm.R;}const p=mkP('R',s.x,s.y,tx,ty,{li:2.5,sp:350,r:24});p._kh=false;G.proj.push(p);burst(s.x,s.y,'#aa00ff',16,65,.6);nburst(s.x,s.y,7);swave(s.x,s.y,tx-s.x,ty-s.y,'#aa00ff',7);ring(s.x,s.y,'#aa00ff',100,.5);if(isKite)kiteFired();}
}
function doCast(ab){const s=G.s;if(!s||!s.alive)return;if(s.cd[ab]>0)return;if(ab==='E'&&s.mn<s.mc.E)return;if(ab==='R'&&s.en<s.ec.R)return;
  if(ab==='W'){let gi=-1;for(let i=0;i<3;i++){if(s.gcd[i]<=0&&!G.stg.find(st=>st.gi===i&&st.act)){gi=i;break;}}if(gi<0)return;G.stg.push(mkStg(s.x,s.y,gi));s.cd.W=s.cdm.W;burst(s.x,s.y,'#ffd700',12,50,.5);nburst(s.x,s.y,3);hiAb('W');return;}
  const tgt=near(s);const tx=tgt?tgt.x:s.x,ty=tgt?tgt.y:s.y-100;
  if(ab==='E'){s.mn-=s.mc.E;s.cd.E=s.cdm.E;G.proj.push(mkP('E',s.x,s.y,tx,ty,{li:1.2,sp:500,r:14,dmg:65}));burst(s.x,s.y,'#2196f3',8,35);swave(s.x,s.y,tx-s.x,ty-s.y,'#2196f3',5);hiAb('E');}
  else if(ab==='R'){s.en-=s.ec.R;s.cd.R=s.cdm.R;G.proj.push(mkP('R',s.x,s.y,tx,ty,{li:2.5,sp:350,r:24}));burst(s.x,s.y,'#aa00ff',16,65,.6);nburst(s.x,s.y,7);swave(s.x,s.y,tx-s.x,ty-s.y,'#aa00ff',7);ring(s.x,s.y,'#aa00ff',100,.5);hiAb('R');}
}
function doEc(s,ab,tx,ty){if(s.ecR&&!s.ecU){s.ecU=true;s.ecR=false;setTimeout(()=>{const t2=near(s);const tx2=t2?t2.x:tx,ty2=t2?t2.y:ty;let ep;if(ab==='Q1')ep=mkP('Q1',s.x,s.y,tx2,ty2,{li:.55,sp:550,r:s.amp?85:65,dmg:65});else ep=mkP('Q2',s.x,s.y,tx2,ty2,{li:.5,sp:600,r:s.amp?38:28,dmg:105});ep._echo=true;ep._kh=false;G.proj.push(ep);burst(s.x,s.y,'#f48fb1',7,35);nburst(s.x,s.y,3);ftxt(s.x,s.y-40,'ECHO','#f48fb1',12);},320);}}

// ═══ COMBAT ═══
function hitEn(d,p){const s=G.s;
  // Kite aim trainer targets
  if(d.ktgt&&G.kite){
    p._kh=true;
    const kill=kiteHit(d,p);
    if(kill){d.alive=false;d.hp=0;d.dt=0;burst(d.x,d.y,'#ff1744',16,50,.4);ring(d.x,d.y,d.col||'#ff1744',40,.35);}
    return;
  }
  p._kh=true;
  let dm=p.dmg||80;
  // Q1: % max HP scaling — more HP the target has, more damage
  if(p.tp==='Q1')dm+=d.mhp*0.08;
  // R amplification on Q1 and Q2
  if(d.rA>0&&(p.tp==='Q1'||p.tp==='Q2')){dm*=s.dA;ftxt(d.x+15,d.y-45,'AMP!','#ff5252',12);}
  // Q2: % missing HP scaling — execute damage, more missing = more damage
  if(p.tp==='Q2')dm*=(1+(1-d.hp/d.mhp)*1.0);
  if(d.sh>0&&p.tp!=='E'){const ab=Math.min(d.sh,dm);d.sh-=ab;dm-=ab;if(d.sh<=0){ftxt(d.x,d.y-40,'BROKE','#00e5ff',12);burst(d.x,d.y,'#00e5ff',6,18);}}d.hp-=dm;ftxt(d.x,d.y-28,`-${Math.round(dm)}`,p.tp==='Q1'?'#f48fb1':'#ffd700',17);
  // Soul Read: lasts exactly as long as the Q2 recast window
  if(p.tp==='Q1'){d.sr=s.qRecastMax;ftxt(d.x+25,d.y-55,'SOUL READ','#90caf9',10);}
  // Tempo Break: Q2 applies haste reduction, keeps CD panel visible
  if(p.tp==='Q2'){d.tb=5;d.sr=Math.max(d.sr,d.tb);ftxt(d.x+25,d.y-55,'TEMPO BREAK','#ffb74d',10);}
  if(d.hp<=0)killEn(d,p.tp);}
function breakG(st){const s=G.s;st.act=false;st.gh=0;s.en=Math.min(s.men,s.en+1);s.gcd[st.gi]=s._kiteGCD||11;burst(st.x,st.y,'#ffd700',18,55,.5);ring(st.x,st.y,'#ffd700',70,.45);nburst(st.x,st.y,5);ftxt(st.x,st.y-25,'+1⚡','#ffd700',18);hiAb('W');}
function killEn(d,src){d.alive=false;d.hp=0;d.dt=0;burst(d.x,d.y,'#ff1744',22,70,.6,3);ring(d.x,d.y,'#ff1744',55,.45);ftxt(d.x,d.y-40,'KILL','#ff1744',22);if(src==='Q2'&&d.rA>0){const s=G.s;for(let i=0;i<3;i++){if(s.gcd[i]>0){s.gcd[i]=0;ftxt(s.x,s.y-50,'⚡RESET','#ffd700',20);burst(s.x,s.y,'#ffd700',14,45);ring(s.x,s.y,'#ffd700',60,.35);break;}}}}
function sDie(){const s=G.s;s.alive=false;burst(s.x,s.y,'#e84393',30,70,.7);ring(s.x,s.y,'#e84393',90,.5);
  const activeGuards=G.stg.filter(st=>st.act);
  const guardCount=activeGuards.length;
  activeGuards.forEach((st,i)=>{
    setTimeout(()=>{
      st.act=false;s.en=Math.min(s.men,s.en+1);
      burst(st.x,st.y,'#ffd700',22,60,.6);ring(st.x,st.y,'#ffd700',80,.5);nburst(st.x,st.y,7);
      ftxt(st.x,st.y-30,'+1⚡ GUARD LOST','#ffd700',16);
      if(i===guardCount-1&&guardCount>0){
        setTimeout(()=>{ftxt(s.x,s.y-60,`⚡ ${guardCount} ENERGY REFUNDED ⚡`,'#ffd700',20);ring(s.x,s.y,'#ffd700',120,.6);},300);
      }
    },i*600);
  });
  if(guardCount===0)ftxt(s.x,s.y-50,'DEFEATED','#e84393',14);
  if(mode==='kite'&&G.kite){
    G.kite.score=Math.max(0,G.kite.score*0.7);
    ftxt(s.x,s.y-70,'DEATH PENALTY -30%','#ef5350',16);
    setTimeout(()=>{G.kite.active=false;kiteEnd();},1500);
    return;
  }
  const isRefundRound=G.ai&&ROUNDS[G.ai.round%ROUNDS.length].letSeraDie&&!G.ai.refundExecute;
  const respawnDelay=Math.max(4,guardCount*0.6+3);
  const rb=document.getElementById('rbar');rb.classList.add('on');let rt=respawnDelay;
  const ri=setInterval(()=>{rt-=.1;rb.textContent=`RESPAWNING ${Math.ceil(rt)}s`;if(rt<=0){clearInterval(ri);rb.classList.remove('on');
    s.alive=true;s.mn=s.mmn;s.x=W/2;s.y=mode==='kite'?H*.85:H*.55;s.inv=1.5;
    G.stg=[];for(let i=0;i<3;i++)s.gcd[i]=0;
    s.qPhase=0;s.qRecast=0;s.cd.Q=0;s.cd.W=0;s.cd.E=0;s.cd.R=0;moveTo=null;
    if(G.ai){
      if(isRefundRound){
        // Respawn with full energy from refund — let normal AI take over
        s.hp=1500;s.mhp=1500;
        G.ai.refundExecute=true;
        // Normal AI: place stages first, then fight with full kit
        G.ai.phase='setup';G.ai.stagesPlaced=0;G.ai.thinkCD=0.5;
        // Spawn a fresh dummy that actually fights back
        G.en=G.en.filter(e=>e.jnk);
        const edy=H*.36,edx=W/2;
        G.en.push(mkE(edx,edy,{hp:850,shi:4,rt:99,sx:edx,sy:edy,ar:260,ai:1.2,ad:50,msh:140,
          chase:false,spd:0,pace:true,paceSpd:55,
          paceXMin:W/2-100,paceXMax:W/2+100,paceYMin:edy-H*.06,paceYMax:edy+H*.06,
          dab:{Q:{cd:0,mcd:3,name:'Pummel',col:'#ef5350'},W:{cd:0,mcd:6,name:'Iron Skin',col:'#00e5ff'},E:{cd:0,mcd:5,name:'Sap',col:'#66bb6a'},R:{cd:0,mcd:12,name:'Execute',col:'#ffa726'}}
        }));
        ftxt(s.x,s.y-50,'FULL ENERGY — FIGHT!','#f48fb1',16);
      } else {
        s.hp=s.mhp;
        G.ai.phase='setup';G.ai.stagesPlaced=0;G.ai.thinkCD=0.3;
      }
    } else { s.hp=s.mhp; }
  }},100);}


// ═══ UPDATE ═══
function update(dt){
  const s=G.s;if(!s)return;G.t+=dt;
  for(const k in s.cd)if(s.cd[k]>0)s.cd[k]=Math.max(0,s.cd[k]-dt);
  for(let i=0;i<3;i++)if(s.gcd[i]>0)s.gcd[i]=Math.max(0,s.gcd[i]-dt);
  if(s.inv>0)s.inv-=dt;
  // Q recast window countdown
  if(s.qPhase===1){s.qRecast-=dt;if(s.qRecast<=0){s.qPhase=0;s.qRecast=0;s.cd.Q=s.cdm.Q1;}}// expired without Q2 → Q1 cooldown
  s.mn=Math.min(s.mmn,s.mn+10*dt);
  // Movement
  if(s.alive&&moveTo&&!G.dOn){const dx=moveTo.x-s.x,dy=moveTo.y-s.y,d=Math.hypot(dx,dy);if(d>4){s.x+=dx/d*s.spd*dt;s.y+=dy/d*s.spd*dt;s.trail.push({x:s.x,y:s.y,a:0});}else moveTo=null;if(s.trail.length>25)s.trail.shift();}
  if(s.alive&&G.dOn&&G._dMov){const dx=G._dMov.x-s.x,dy=G._dMov.y-s.y,d=Math.hypot(dx,dy);if(d>4){s.x+=dx/d*s.spd*dt;s.y+=dy/d*s.spd*dt;const ll=W/2-145,lr=W/2+145;const sTop=G.etur?(G.etur.y+G.etur.rng+15):H*.25;s.x=Math.max(ll,Math.min(lr,s.x));s.y=Math.max(sTop,Math.min(H*.75,s.y));s.trail.push({x:s.x,y:s.y,a:0});}else G._dMov=null;if(s.trail.length>25)s.trail.shift();}
  // Passive
  s.onS=null;s.amp=false;
  for(const st of G.stg){if(!st.act)continue;if(Math.hypot(s.x-st.x,s.y-st.y)<st.r){s.onS=st;s.amp=true;if(!s.ecU)s.ecR=true;break;}}
  if(s.amp!==s._prevAmp){s._prevAmp=s.amp;hiAb('P');}
  if(!s.amp){s.ecR=false;s.ecU=false;}
  // Enemies
  for(const d of G.en){
    if(!d.alive){d.dt+=dt;if(d.dt>=d.rt){d.alive=true;d.hp=d.mhp;d.sh=0;d.si=0;d.ah=0;d.rA=0;d.tb=0;d.sr=0;d.dt=0;d.x=d.sx;d.y=d.sy;d.at=0;d.sht=0;if(d.dab){for(const k in d.dab)d.dab[k].cd=0;}burst(d.x,d.y,'#ef9a9a',10,30);}continue;}
    if(d.si>0)d.si-=dt;if(d.ah>0)d.ah-=dt;if(d.rA>0)d.rA-=dt;if(d.tb>0)d.tb-=dt;if(d.sr>0)d.sr-=dt;
    // ─── DUMMY ABILITY COOLDOWNS (Tempo Break slows recovery) ───
    if(d.dab){
      const cdRate=d.tb>0?0.45:1; // Tempo Break = 55% slower CD recovery
      for(const k in d.dab){if(d.dab[k].cd>0)d.dab[k].cd=Math.max(0,d.dab[k].cd-dt*cdRate);}
    }
    // ─── DUMMY ABILITY AI — uses QWER when ready and not silenced ───
    if(d.dab&&d.si<=0&&s.alive){
      const dist2=Math.hypot(d.x-s.x,d.y-s.y);
      const ab=d.dab;
      // R: Unleash — big burst projectile, use when Sera is low HP
      if(ab.R.cd<=0&&dist2<d.ar&&s.hp<s.mhp*.5){
        ab.R.cd=ab.R.mcd;
        // Cast windup visual
        ring(d.x,d.y,ab.R.col,50,.5);ring(d.x,d.y,ab.R.col,30,.4);
        burst(d.x,d.y,ab.R.col,16,55,.6);
        swave(d.x,d.y,s.x-d.x,s.y-d.y,ab.R.col,5);
        ftxt(d.x,d.y-d.r-35,ab.R.name.toUpperCase(),ab.R.col,14);
        // Big slow projectile
        G.proj.push(mkP('dR',d.x,d.y,s.x,s.y,{li:4,sp:300,r:16,dmg:d.ad*2}));
      }
      // W: Barrier — self shield with big visual pop
      else if(ab.W.cd<=0&&d.sh<=0){
        ab.W.cd=ab.W.mcd;
        d.sh=d.msh;
        // Shield cast visual — expanding rings + particles
        ring(d.x,d.y,ab.W.col,d.r+25,.5);ring(d.x,d.y,ab.W.col,d.r+12,.35);
        burst(d.x,d.y,ab.W.col,12,35,.4);
        // Orbiting shield particles
        for(let i=0;i<6;i++){const a=i*Math.PI/3;G.fx.push({t:'p',x:d.x+Math.cos(a)*25,y:d.y+Math.sin(a)*25,vx:Math.cos(a+1.5)*40,vy:Math.sin(a+1.5)*40,li:.6,a:0,c:ab.W.col,sz:3});}
        ftxt(d.x,d.y-d.r-35,ab.W.name.toUpperCase(),ab.W.col,13);
      }
      // E: Drain — self heal with visible channel effect
      else if(ab.E.cd<=0&&d.hp<d.mhp*.7){
        ab.E.cd=ab.E.mcd;
        let heal=d.mhp*.15;
        if(d.ah>0){heal*=.35;ftxt(d.x+25,d.y-20,'ANTI-HEAL!','#ef5350',11);}
        d.hp=Math.min(d.mhp,d.hp+heal);
        // Heal visual — green particles rising upward + rings
        ring(d.x,d.y,ab.E.col,25,.4);
        for(let i=0;i<8;i++){G.fx.push({t:'n',x:d.x-12+Math.random()*24,y:d.y+10,vx:(Math.random()-.5)*30,vy:-40-Math.random()*30,no:'+',a:0,li:.7+Math.random()*.3,c:ab.E.col});}
        burst(d.x,d.y,ab.E.col,8,25,.35);
        ftxt(d.x,d.y-d.r-35,`${ab.E.name.toUpperCase()} +${Math.round(heal)}`,d.ah>0?'#ef5350':ab.E.col,13);
      }
      // Q: Bolt — visible skillshot projectile with trail
      else if(ab.Q.cd<=0&&dist2<d.ar){
        ab.Q.cd=ab.Q.mcd;
        // Cast visual — small burst at source
        burst(d.x,d.y,ab.Q.col,6,20,.3);
        swave(d.x,d.y,s.x-d.x,s.y-d.y,ab.Q.col,3);
        ftxt(d.x,d.y-d.r-35,ab.Q.name.toUpperCase(),ab.Q.col,11);
        // Skillshot projectile
        G.proj.push(mkP('dQ',d.x,d.y,s.x,s.y,{li:3.5,sp:380,r:8,dmg:d.ad}));
      }
    }
    if(d.chase&&s.alive){const dx=s.x-d.x,dy=s.y-d.y,dd=Math.hypot(dx,dy);const stopDist=Math.max(d.ar*.55,d.r+s.r+45);if(dd>stopDist){d.x+=dx/dd*d.spd*dt;d.y+=dy/dd*d.spd*dt;}else if(dd<d.r+s.r+30){const pd=(d.r+s.r+35-dd);d.x-=dx/dd*pd*0.3;d.y-=dy/dd*pd*0.3;}const dBot=G.tur?(G.tur.y-G.tur.rng-15):H*.65;d.x=Math.max(W/2-145,Math.min(W/2+145,d.x));d.y=Math.max(H*.12,Math.min(dBot,d.y));}
    // Collision separation — hard prevent overlap
    if(s.alive){const cdx=d.x-s.x,cdy=d.y-s.y,cdist=Math.hypot(cdx,cdy),minSep=d.r+s.r+25;if(cdist<minSep&&cdist>0.1){const push=(minSep-cdist);d.x+=cdx/cdist*push*0.6;d.y+=cdy/cdist*push*0.6;s.x-=cdx/cdist*push*0.4;s.y-=cdy/cdist*push*0.4;}}
    // Laning AI — pace independently in zone, walk toward Sera only if very far
    if(d.pace&&!d.chase&&d.si<=0){
      const distToSera=Math.hypot(s.x-d.x,s.y-d.y);
      if(s.alive&&distToSera>d.ar*1.8){
        // Sera is very far — walk toward her slowly
        const dx=s.x-d.x,dy=s.y-d.y,dd=Math.hypot(dx,dy);
        d.x+=dx/dd*d.paceSpd*.8*dt;d.y+=dy/dd*d.paceSpd*.8*dt;
        const dBot2=G.tur?(G.tur.y-G.tur.rng-15):H*.65;d.x=Math.max(W/2-145,Math.min(W/2+145,d.x));d.y=Math.max(H*.12,Math.min(dBot2,d.y));
      }else{
        // Normal pacing — always moving within zone
        if(d.paceWait>0){d.paceWait-=dt;}
        else if(!d.paceTgt||Math.hypot(d.paceTgt.x-d.x,d.paceTgt.y-d.y)<8){
          d.paceTgt={x:d.paceXMin+Math.random()*(d.paceXMax-d.paceXMin),y:d.paceYMin+Math.random()*(d.paceYMax-d.paceYMin)};
          d.paceWait=.2+Math.random()*.5;
        }else{
          const dx=d.paceTgt.x-d.x,dy=d.paceTgt.y-d.y,dd=Math.hypot(dx,dy);
          d.x+=dx/dd*d.paceSpd*dt;d.y+=dy/dd*d.paceSpd*dt;
          const dBot3=G.tur?(G.tur.y-G.tur.rng-15):H*.65;d.x=Math.max(W/2-145,Math.min(W/2+145,d.x));d.y=Math.max(H*.12,Math.min(dBot3,d.y));
        }
      }
    }
    if(d.heal&&d.si<=0){d.ht+=dt;if(d.ht>=d.hi){d.ht=0;for(const d2 of G.en){if(d2!==d&&d2.alive&&Math.hypot(d2.x-d.x,d2.y-d.y)<250){let h=d.ha;if(d2.ah>0)h*=.4;d2.hp=Math.min(d2.mhp,d2.hp+h);burst(d2.x,d2.y,'#66bb6a',4,12);ftxt(d2.x,d2.y-25,`+${Math.round(h)}`,'#a5d6a7',12);}}}}
    // ─── DUMMY AUTO-ATTACK — fires independently on timer ───
    if(s.alive&&d.si<=0){
      d.at+=dt;
      const aDist=Math.hypot(s.x-d.x,s.y-d.y);
      if(d.at>=d.ai&&aDist<d.ar){
        d.at=0;
        G.proj.push(mkP('dA',d.x,d.y,s.x,s.y,{li:3,sp:420,r:7,dmg:d.ad}));
        burst(d.x,d.y,'#ef5350',4,15,.25);
      }
    }
  }
  // Jungler
  if((mode==='practice'||mode==='sandbox')&&s.alive){G.jT+=dt;if(!G.jA&&G.jT>=G.jI){G.jT=0;G.jI=50+Math.random()*30;G.jA=true;const side=Math.random()>.5;const jx=side?W*.05:W*.95;const jy=H*.3+Math.random()*H*.3;G.jk=mkE(jx,jy,{chase:true,spd:120,hp:700,ar:230,ai:1.8,ad:55,lbl:'⚔ Jungler',col:'#e65100',shi:8,rt:99,sx:jx,sy:jy,jnk:true});G.jk._st=G.t;G.en.push(G.jk);ftxt(W/2,H*.35,'⚠ GANK','#ff6d00',26);ring(jx,jy,'#ff6d00',80,.6);burst(jx,jy,'#ff6d00',14,50);}
    if(G.jA&&G.jk){if(!G.jk.alive){G.jA=false;G.jk=null;}else{const ji=G.en.indexOf(G.jk);if(ji>=0&&G.t-(G.jk._st||0)>12){const rx=G.jk.x<W/2?-50:W+50;G.jk.x+=(rx-G.jk.x)*.03;if(G.jk.x<-60||G.jk.x>W+60){G.en.splice(ji,1);G.jA=false;G.jk=null;}}}}}
  // Turret
  if(G.tur){const tu=G.tur;tu.at+=dt;let tt=null,td=1e9;for(const d of G.en){if(!d.alive)continue;const dd=Math.hypot(d.x-tu.x,d.y-tu.y);if(dd<tu.rng&&dd<td){td=dd;tt=d;}}if(tt&&tu.at>=tu.ai){tu.at=0;G.proj.push(mkP('tA',tu.x,tu.y,tt.x,tt.y,{li:1,sp:650,r:10,dmg:tu.dmg,tid:G.en.indexOf(tt)}));burst(tu.x,tu.y,'#ffd700',4,20);}}
  // Enemy turret — attacks Sera
  if(G.etur){const et=G.etur;et.at+=dt;const s2=G.s;if(s2&&s2.alive){const dd=Math.hypot(s2.x-et.x,s2.y-et.y);if(dd<et.rng&&et.at>=et.ai){et.at=0;G.proj.push(mkP('dA',et.x,et.y,s2.x,s2.y,{li:3,sp:650,r:10,dmg:et.dmg}));burst(et.x,et.y,'#ef5350',4,20);}}}
  // Projectiles
  for(let i=G.proj.length-1;i>=0;i--){
    const p=G.proj[i];p.a+=dt;if(p.a>p.li){G.proj.splice(i,1);continue;}
    p.x+=p.dx*p.sp*dt;p.y+=p.dy*p.sp*dt;
    if(p.x<-80||p.x>W+80||p.y<-80||p.y>H+80){G.proj.splice(i,1);continue;}
    if(p.tp==='Q1'||p.tp==='Q2'){if(Math.hypot(p.x-p.tx,p.y-p.ty)<30&&!p.hit){p.hit=true;if(p.tp==='Q1'){ring(p.x,p.y,'#e84393',p.r*1.5,.45);burst(p.x,p.y,'#e84393',14,45,.4);nburst(p.x,p.y,4);}else{ring(p.x,p.y,'#ffd700',p.r,.35);burst(p.x,p.y,'#ffd700',18,55,.5,3);}for(const d of G.en){if(!d.alive)continue;if(Math.hypot(d.x-p.x,d.y-p.y)<p.r+d.r)hitEn(d,p);}if(mode==='kite'&&G.kite&&!p._kh&&!p._km&&!p._echo){p._km=true;kiteMiss();}}if(p.hit&&p.a>p.li*.7)G.proj.splice(i,1);}
    else if(p.tp==='E'){let eHit=false;for(const d of G.en){if(!d.alive||p.hit)continue;if(Math.hypot(d.x-p.x,d.y-p.y)<p.r+d.r){p.hit=true;eHit=true;
      if(d.ktgt&&G.kite){p._kh=true;const kill=kiteHit(d,p);if(kill){d.alive=false;d.hp=0;d.dt=0;burst(d.x,d.y,'#00e5ff',14,40,.4);}G.proj.splice(i,1);break;}
      if(d.sh>0){d.sh=0;burst(d.x,d.y,'#00e5ff',14,35,.4);ring(d.x,d.y,'#00e5ff',45,.3);ftxt(d.x,d.y-35,'SHATTERED','#00e5ff',14);}let dm=p.dmg*s.dA;d.hp-=dm;ftxt(d.x,d.y-22,`-${Math.round(dm)}`,'#64b5f6',15);burst(d.x,d.y,'#2196f3',8,25);if(d.hp<=0)killEn(d,'E');G.proj.splice(i,1);break;}}if(!eHit&&(p.x<-80||p.x>W+80||p.y<-80||p.y>H+80)&&mode==='kite'&&G.kite&&!p._km){p._km=true;kiteMiss();}}
    else if(p.tp==='R'){let rHit=false;for(const d of G.en){if(!d.alive)continue;if(Math.hypot(d.x-p.x,d.y-p.y)<p.r+d.r+10){rHit=true;p._kh=true;if(d.si<=0||d.rA<=0){d.si=3;d.ah=5;d.rA=6;s.dA=1.35;ftxt(d.x,d.y-35,'SILENCED','#aa00ff',17);burst(d.x,d.y,'#aa00ff',18,45,.5);ring(d.x,d.y,'#aa00ff',55,.4);nburst(d.x,d.y,5);p.a=Math.max(0,p.a-.7);}}}if(!rHit&&(p.x<-80||p.x>W+80||p.y<-80||p.y>H+80)&&mode==='kite'&&G.kite&&!p._km){p._km=true;kiteMiss();}}
    else if(p.tp==='dA'||p.tp==='dQ'||p.tp==='dR'){if(Math.hypot(p.x-s.x,p.y-s.y)<s.r+p.r){let dm=p.dmg;const wasOnStage=!!(s.onS&&s.onS.act&&s.onS.gh>0);if(s.onS&&s.onS.act&&s.onS.gh>0){const rd=dm*.4;dm-=rd;s.onS.gh-=p.dmg*.7;ftxt(s.x-20,s.y-35,`-${Math.round(p.dmg*.7)}`,'#ffd700',10);burst(s.x,s.y,'#ffd700',4,15,.3);if(s.onS.gh<=0)breakG(s.onS);}if(s.inv<=0){s.hp-=dm;if(mode==='kite'&&G.kite)kiteDmg(dm,wasOnStage);ftxt(s.x,s.y-25,`-${Math.round(dm)}`,p.tp==='dR'?'#ffa726':'#ef5350',15);burst(s.x,s.y,p.tp==='dR'?'#ffa726':'#ef5350',p.tp==='dR'?10:5,p.tp==='dR'?30:18);if(p.tp==='dR'){ring(s.x,s.y,'#ffa726',35,.35);ftxt(s.x+15,s.y-45,'BIG HIT','#ffa726',11);}if(s.hp<=0){s.hp=0;sDie();}}G.proj.splice(i,1);continue;}}
    else if(p.tp==='tA'){const tgt=G.en[p.d.tid];if(tgt&&tgt.alive&&Math.hypot(tgt.x-p.x,tgt.y-p.y)<tgt.r+p.r){tgt.hp-=p.dmg;ftxt(tgt.x,tgt.y-25,`-${p.dmg}`,'#ffd700',16);burst(tgt.x,tgt.y,'#ffd700',10,35,.4);ring(tgt.x,tgt.y,'#ffd700',35,.3);if(tgt.hp<=0)killEn(tgt,'Turret');G.proj.splice(i,1);}}
  }
  // FX
  for(let i=G.fx.length-1;i>=0;i--){const f=G.fx[i];f.a+=dt;if(f.a>f.li){G.fx.splice(i,1);continue;}if(f.t==='p'||f.t==='n'){f.x+=(f.vx||0)*dt;f.y+=(f.vy||0)*dt;f.vx*=.95;f.vy*=.95;if(f.t==='n')f.vy-=18*dt;}}
  for(const t of s.trail)t.a+=dt;s.trail=s.trail.filter(t=>t.a<.35);
  let anyR=false;for(const d of G.en)if(d.rA>0)anyR=true;if(!anyR)s.dA=1;
  // Demo AI brain
  if(G.dOn&&G.ai){aiTick(dt);}
  if(G.dOn&&!G.ai&&G.dQ&&G.dQ.length>0){G.dT-=dt;if(G.dT<=0){const a=G.dQ.shift();if(a)a();}}
  if(G.dOn&&!G.ai&&(!G.dQ||!G.dQ.length)&&G.dT<=0)G.dOn=false;
  // Kite aim trainer
  if(mode==='kite'&&G.kite)kiteTick(dt);
  updateHUD();
}

// ═══ RENDER ═══
function render(){
  cx.clearRect(0,0,W,H);
  const bg=cx.createLinearGradient(0,0,0,H);bg.addColorStop(0,'#0d1a0d');bg.addColorStop(.3,'#0a1428');bg.addColorStop(.7,'#0a1428');bg.addColorStop(1,'#0d1a0d');cx.fillStyle=bg;cx.fillRect(0,0,W,H);
  cx.globalAlpha=.025;cx.fillStyle='#1a3a1a';for(let x=0;x<W;x+=35)for(let y=0;y<H;y+=35){if((Math.floor(x/35)+Math.floor(y/35))%2===0)cx.fillRect(x,y,35,35);}cx.globalAlpha=1;
  const lw=Math.min(320,W*.4);cx.fillStyle='rgba(200,170,110,.02)';cx.fillRect(W/2-lw/2,0,lw,H);
  cx.strokeStyle='rgba(200,170,110,.05)';cx.lineWidth=1.5;cx.setLineDash([15,30]);cx.beginPath();cx.moveTo(W/2,0);cx.lineTo(W/2,H);cx.stroke();cx.setLineDash([]);
  cx.fillStyle='rgba(20,60,20,.15)';cx.fillRect(0,H*.2,W*.08,H*.3);cx.fillRect(W*.92,H*.4,W*.08,H*.25);
  const s=G.s;
  if(G.tur)drawTur(G.tur);
  if(G.etur)drawETur(G.etur);
  for(const st of G.stg)drawStg(st,G.t);
  if(s&&s.alive){for(const t of s.trail){const a=1-t.a/.35;cx.globalAlpha=a*.12;cx.fillStyle='#e84393';cx.beginPath();cx.arc(t.x,t.y,s.r*.45,0,Math.PI*2);cx.fill();}cx.globalAlpha=1;}
  for(const d of G.en)drawEn(d,G.t);
  if(s&&s.alive)drawSera(s,G.t);
  // Projectiles
  for(const p of G.proj){cx.save();
    if(p.tp==='Q1'){if(p.hit){const pg=(p.a-p.li*.3)/(p.li*.7);cx.globalAlpha=Math.max(0,1-pg);const eg=cx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.r*1.5);eg.addColorStop(0,'rgba(232,67,147,.5)');eg.addColorStop(.5,'rgba(196,77,255,.25)');eg.addColorStop(1,'transparent');cx.fillStyle=eg;cx.beginPath();cx.arc(p.x,p.y,p.r*1.5*Math.min(1,pg*2),0,Math.PI*2);cx.fill();for(let i=0;i<3;i++){cx.strokeStyle=`rgba(232,67,147,${.25*(1-pg)})`;cx.lineWidth=1.5;cx.beginPath();cx.arc(p.x,p.y,p.r*(.4+pg+i*.25),0,Math.PI*2);cx.stroke();}}else{cx.shadowColor='#e84393';cx.shadowBlur=12;const og=cx.createRadialGradient(p.x,p.y,0,p.x,p.y,10);og.addColorStop(0,'#f48fb1');og.addColorStop(1,'#e84393');cx.fillStyle=og;cx.beginPath();cx.arc(p.x,p.y,9,0,Math.PI*2);cx.fill();cx.fillStyle='rgba(244,143,177,.25)';cx.beginPath();cx.arc(p.x-p.dx*12,p.y-p.dy*12,6,0,Math.PI*2);cx.fill();}}
    else if(p.tp==='Q2'){if(p.hit){const pg=(p.a-p.li*.3)/(p.li*.7);cx.globalAlpha=Math.max(0,1-pg);cx.fillStyle='#ffd700';cx.beginPath();cx.arc(p.x,p.y,p.r*Math.min(1,pg*3),0,Math.PI*2);cx.fill();cx.strokeStyle='#fff';cx.lineWidth=2;for(let i=0;i<6;i++){const a=i*Math.PI/3+G.t*3;cx.beginPath();cx.moveTo(p.x,p.y);cx.lineTo(p.x+Math.cos(a)*p.r*pg,p.y+Math.sin(a)*p.r*pg);cx.stroke();}}else{cx.shadowColor='#ffd700';cx.shadowBlur=16;cx.fillStyle='#ffd700';cx.beginPath();cx.arc(p.x,p.y,6,0,Math.PI*2);cx.fill();cx.fillStyle='#fff';cx.beginPath();cx.arc(p.x,p.y,2.5,0,Math.PI*2);cx.fill();}}
    else if(p.tp==='E'){cx.shadowColor='#2196f3';cx.shadowBlur=10;const px=-p.dy,py=p.dx;for(let i=-2;i<=2;i++){cx.globalAlpha=.5-Math.abs(i)*.08;cx.strokeStyle='#64b5f6';cx.lineWidth=2.5;cx.beginPath();cx.arc(p.x+px*i*6,p.y+py*i*6,p.r-Math.abs(i)*2,0,Math.PI*2);cx.stroke();}cx.globalAlpha=1;cx.fillStyle='#2196f3';cx.beginPath();cx.arc(p.x,p.y,p.r*.5,0,Math.PI*2);cx.fill();}
    else if(p.tp==='R'){cx.shadowColor='#aa00ff';cx.shadowBlur=22;const rS=p.r+Math.sin(G.t*10)*3;const rg=cx.createRadialGradient(p.x,p.y,0,p.x,p.y,rS*2);rg.addColorStop(0,'rgba(170,0,255,.6)');rg.addColorStop(.5,'rgba(170,0,255,.25)');rg.addColorStop(1,'transparent');cx.fillStyle=rg;cx.beginPath();cx.arc(p.x,p.y,rS*2,0,Math.PI*2);cx.fill();cx.fillStyle='#d500f9';cx.beginPath();cx.arc(p.x,p.y,rS*.6,0,Math.PI*2);cx.fill();for(let i=0;i<3;i++){cx.globalAlpha=.15-.03*i;cx.strokeStyle='#ea80fc';cx.lineWidth=1.5;cx.beginPath();cx.arc(p.x,p.y,rS*(1.4+i*.4)+Math.sin(G.t*5+i)*4,0,Math.PI*2);cx.stroke();}cx.globalAlpha=1;cx.fillStyle='rgba(234,128,252,.4)';cx.font='11px serif';cx.textAlign='center';for(let i=0;i<3;i++){const a=G.t*3+i*2.1;cx.fillText('♪',p.x+Math.cos(a)*rS*2.3,p.y+Math.sin(a)*rS*2.3);}}
    else if(p.tp==='dA'){cx.fillStyle='#ef5350';cx.shadowColor='#ef5350';cx.shadowBlur=6;cx.beginPath();cx.arc(p.x,p.y,p.r,0,Math.PI*2);cx.fill();}
    else if(p.tp==='dQ'){
      // Skillshot — pointed bolt with trail
      cx.save();cx.shadowColor='#ef5350';cx.shadowBlur=10;
      const ang=Math.atan2(p.dy,p.dx);cx.translate(p.x,p.y);cx.rotate(ang);
      // Trail
      cx.globalAlpha=.2;cx.fillStyle='#ef5350';cx.fillRect(-20,-3,20,6);
      cx.globalAlpha=.1;cx.fillRect(-35,-2,15,4);
      cx.globalAlpha=1;
      // Bolt head
      cx.fillStyle='#ff8a80';cx.beginPath();cx.moveTo(10,0);cx.lineTo(-4,-5);cx.lineTo(-4,5);cx.closePath();cx.fill();
      cx.fillStyle='#fff';cx.beginPath();cx.arc(2,0,2,0,Math.PI*2);cx.fill();
      cx.restore();
    }
    else if(p.tp==='dR'){
      // Big ult projectile — glowing orb with rings
      cx.save();cx.shadowColor='#ffa726';cx.shadowBlur=18;
      const rg2=cx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.r*2);
      rg2.addColorStop(0,'rgba(255,167,38,.6)');rg2.addColorStop(.5,'rgba(255,167,38,.2)');
      rg2.addColorStop(1,'transparent');
      cx.fillStyle=rg2;cx.beginPath();cx.arc(p.x,p.y,p.r*2,0,Math.PI*2);cx.fill();
      cx.fillStyle='#ffa726';cx.beginPath();cx.arc(p.x,p.y,p.r,0,Math.PI*2);cx.fill();
      cx.fillStyle='#fff3e0';cx.beginPath();cx.arc(p.x,p.y,p.r*.4,0,Math.PI*2);cx.fill();
      // Spinning ring
      cx.strokeStyle='rgba(255,167,38,.4)';cx.lineWidth=1.5;
      cx.beginPath();cx.arc(p.x,p.y,p.r*1.6+Math.sin(G.t*8)*3,G.t*4,G.t*4+Math.PI*1.5);cx.stroke();
      cx.restore();
    }
    else if(p.tp==='tA'){cx.fillStyle='#ffd700';cx.shadowColor='#ffd700';cx.shadowBlur=12;cx.beginPath();cx.arc(p.x,p.y,p.r,0,Math.PI*2);cx.fill();cx.fillStyle='#fff';cx.beginPath();cx.arc(p.x,p.y,p.r*.35,0,Math.PI*2);cx.fill();}
    cx.restore();}
  // FX
  for(const f of G.fx){const a=1-f.a/f.li;cx.save();cx.globalAlpha=a;
    if(f.t==='p'){const pr=Math.max(0,f.sz*a);cx.fillStyle=f.c;cx.beginPath();cx.arc(f.x,f.y,pr,0,Math.PI*2);cx.fill();}
    else if(f.t==='r'){const r=Math.max(0,f.mr*(f.a/f.li));cx.strokeStyle=f.c;cx.lineWidth=Math.max(.1,2*a);cx.beginPath();cx.arc(f.x,f.y,r,0,Math.PI*2);cx.stroke();}
    else if(f.t==='t'){cx.fillStyle=f.c;cx.font=`bold ${f.sz}px Rajdhani`;cx.textAlign='center';cx.fillText(f.tx,f.x,f.y-f.a*45);}
    else if(f.t==='w'){const d=f.a*f.sp;cx.strokeStyle=f.c;cx.lineWidth=2*a;cx.beginPath();cx.moveTo(f.x,f.y);cx.lineTo(f.x+Math.cos(f.ang)*d,f.y+Math.sin(f.ang)*d);cx.stroke();}
    else if(f.t==='n'){cx.fillStyle=f.c;cx.font=`${Math.max(1,12*a)}px serif`;cx.textAlign='center';cx.fillText(f.no,f.x,f.y);}
    cx.restore();}
  if(moveTo&&!G.dOn){cx.save();cx.globalAlpha=.3;cx.strokeStyle='#c8aa6e';cx.lineWidth=1;cx.beginPath();cx.arc(moveTo.x,moveTo.y,7+Math.sin(G.t*3)*2,0,Math.PI*2);cx.stroke();cx.restore();}
  if(s&&s.alive){const rng=s.amp?s.arng:s.rng;cx.save();cx.globalAlpha=.05;cx.strokeStyle=s.amp?'#e84393':'#4fc3f7';cx.lineWidth=1;cx.setLineDash([3,5]);cx.beginPath();cx.arc(s.x,s.y,rng,0,Math.PI*2);cx.stroke();cx.setLineDash([]);cx.restore();}
  // ═══ KITE MODE CANVAS LEGEND ═══
  if(mode==='kite'&&G.kite&&G.kite.active){
    const L=G.kite.L;
    const entries=[];
    if(L.types.includes('q1'))entries.push({col:'#e84393',desc:'PINK = Q'});
    if(L.types.includes('q2'))entries.push({col:'#ffd700',desc:'GOLD ★ = Q (2x)'});
    if(L.types.includes('shield'))entries.push({col:'#00bcd4',desc:'CYAN = E → Q'});
    if(L.types.includes('r_tgt'))entries.push({col:'#aa00ff',desc:'PURPLE = R → Q'});
    entries.push({col:'#ef5350',desc:'RED = dodge!'});
    const rx=W-12, ly=180;
    cx.save();
    cx.textAlign='right';
    // Entries — right-aligned, compact
    for(let i=0;i<entries.length;i++){
      const e=entries[i];const ey=ly+i*18;
      cx.font='bold 12px Rajdhani';cx.fillStyle=e.col;
      cx.fillText('●',rx,ey);
      cx.fillStyle='rgba(240,230,210,.7)';cx.font='12px Rajdhani';
      cx.fillText(e.desc+'  ',rx-10,ey);
    }
    // Rules line
    const rulesY=ly+entries.length*18+4;
    cx.font='10px Rajdhani';cx.fillStyle='rgba(200,170,110,.4)';
    cx.fillText('Miss -30 · Off stage -50 · W = stage',rx,rulesY);
    cx.restore();
  }
}

// ═══ HUD ═══
function updateHUD(){
  const s=G.s;if(!s)return;
  document.getElementById('hpF').style.width=(s.hp/s.mhp*100)+'%';document.getElementById('hpV').textContent=`${Math.round(s.hp)} / ${s.mhp}`;
  document.getElementById('mpF').style.width=(s.mn/s.mmn*100)+'%';document.getElementById('mpV').textContent=`${Math.round(s.mn)} / ${s.mmn}`;
  document.getElementById('epF').style.width=(s.en/s.men*100)+'%';document.getElementById('epV').textContent=`${s.en} / ${s.men}`;
  const pb=document.getElementById('passB');if(s.amp){pb.className='passive-b am';pb.textContent='AMPLIFIER';}else{pb.className='passive-b dm';pb.textContent='DAMPENER';}
  for(let i=0;i<3;i++){const g=document.getElementById('g'+i);const pl=G.stg.find(st=>st.gi===i&&st.act);g.className=pl?'gg up':s.gcd[i]>0?'gg cd':'gg dn';}
  // Q slot — changes between Listen (Q1) and Speak (Q2) like Akali R1/R2
  const qEl=document.getElementById('sQ');const qKey=document.getElementById('qKey');const qName=document.getElementById('qName');const qCost=document.getElementById('qCost');
  qEl.classList.remove('rdy','ocd','nr');let qOv=qEl.querySelector('.aov');
  if(s.cd.Q>0&&s.qPhase===0){
    // On full cooldown
    qEl.classList.add('ocd');if(!qOv){qOv=document.createElement('div');qOv.className='aov';qEl.appendChild(qOv);}qOv.textContent=Math.ceil(s.cd.Q);
    qKey.textContent='Q';qName.textContent='Listen';qCost.className='acost m';
  }else if(s.qPhase===1){
    // Recast window — show Q2 Speak
    if(qOv)qOv.remove();
    qKey.textContent='Q';qName.textContent='Speak';qCost.className='acost en';
    qEl.classList.add(s.en>=s.ec.Q2?'rdy':'nr');
    // pulsing border to show recast available
    qEl.style.borderColor=s.en>=s.ec.Q2?'#ffd700':'#5b5a56';
    qEl.style.boxShadow=s.en>=s.ec.Q2?'0 0 8px rgba(255,215,0,.4)':'none';
  }else{
    // Ready for Q1
    if(qOv)qOv.remove();
    qKey.textContent='Q';qName.textContent='Listen';qCost.className='acost m';
    qEl.classList.add(s.mn>=s.mc.Q1?'rdy':'nr');
    qEl.style.borderColor='';qEl.style.boxShadow='';
  }
  const sl={W:'sW',E:'sE',R:'sR'};
  for(const[ab,id]of Object.entries(sl)){const el=document.getElementById(id);const cd=s.cd[ab];el.classList.remove('rdy','ocd','nr');let ov=el.querySelector('.aov');
    if(cd>0){el.classList.add('ocd');if(!ov){ov=document.createElement('div');ov.className='aov';el.appendChild(ov);}ov.textContent=Math.ceil(cd);}
    else{if(ov)ov.remove();let has=true;if(ab==='E'&&s.mn<s.mc.E)has=false;if(ab==='R'&&s.en<s.ec.R)has=false;if(ab==='W'){let any=false;for(let i=0;i<3;i++){if(s.gcd[i]<=0&&!G.stg.find(st=>st.gi===i&&st.act)){any=true;break;}}if(!any)has=false;}el.classList.add(has?'rdy':'nr');}}
}

// ═══ DEMO AI BRAIN ═══
G.ai=null;

// Round definitions — each showcases different kit aspects
const ROUNDS=[
  // Round 1: Standard lane trade — place stages, absorb, full R rotation kill
  { name:'Lane Trade',desc:'Place W stages → absorb damage → guards break → R silence → Q1 max HP burst → Q2 execute',
    hp:1000,ad:22,ai:1.6,shi:4,spd:50,chase:false,
    paceW:90,paceH:.08,startEn:0,msh:140,
    dab:{Q:{cd:0,mcd:3,name:'Bolt',col:'#ef5350'},W:{cd:0,mcd:6,name:'Barrier',col:'#00e5ff'},E:{cd:0,mcd:8,name:'Drain',col:'#66bb6a'},R:{cd:0,mcd:16,name:'Unleash',col:'#ffa726'}}
  },
  // Round 2: R → Q2 KILL → GUARD RESET showcase
  { name:'R+Q2 Guard Reset',desc:'Kill with Q2 while enemy is silenced by R → guard cooldown resets instantly',
    hp:750,ad:20,ai:1.8,shi:5,spd:45,chase:false,
    paceW:80,paceH:.06,startEn:3,msh:120,guardOnCD:true,
    dab:{Q:{cd:0,mcd:4,name:'Spark',col:'#ef5350'},W:{cd:0,mcd:8,name:'Aegis',col:'#00e5ff'},E:{cd:0,mcd:6,name:'Mend',col:'#66bb6a'},R:{cd:0,mcd:18,name:'Blast',col:'#ffa726'}}
  },
  // Round 3: Shield spam — E strips shields then burst kill
  { name:'Shield Breaker',desc:'Damage the dummy → E shatters the shield → chunk to half HP → round advances',
    hp:900,ad:18,ai:1.8,shi:1.5,spd:45,chase:false,
    paceW:80,paceH:.06,startEn:0,msh:200,
    dab:{Q:{cd:0,mcd:4,name:'Spark',col:'#ef5350'},W:{cd:0,mcd:2.5,name:'Aegis',col:'#00e5ff'},E:{cd:0,mcd:6,name:'Mend',col:'#66bb6a'},R:{cd:0,mcd:18,name:'Blast',col:'#ffa726'}}
  },
  // Round 4: All-in burst — full energy, instant combo
  { name:'All-In Execute',desc:'Full energy → E strip → R silence + anti-heal → Q1 max HP chunk → Q2 missing HP execute',
    hp:1100,ad:24,ai:1.4,shi:5,spd:50,chase:false,
    paceW:70,paceH:.07,startEn:3,msh:150,
    dab:{Q:{cd:1.5,mcd:4,name:'Strike',col:'#ef5350'},W:{cd:3,mcd:9,name:'Shell',col:'#00e5ff'},E:{cd:5,mcd:11,name:'Siphon',col:'#66bb6a'},R:{cd:8,mcd:22,name:'Nova',col:'#ffa726'}}
  },
  // Round 5: Extended 2-rotation fight
  { name:'Extended Fight',desc:'Tanky target — Q1 max HP scaling chunks through high HP, needs 2 full rotations',
    hp:1400,ad:20,ai:1.5,shi:3.5,spd:50,chase:false,
    paceW:100,paceH:.09,startEn:0,msh:160,
    dab:{Q:{cd:0,mcd:3,name:'Orb',col:'#ef5350'},W:{cd:0,mcd:6,name:'Wall',col:'#00e5ff'},E:{cd:0,mcd:4,name:'Regen',col:'#66bb6a'},R:{cd:0,mcd:14,name:'Wrath',col:'#ffa726'}}
  },
  // Round 6: Energy Refund on Death — place stages → fight off stage → die → guards break on death → execute on respawn → loop
  { name:'Energy Refund on Death',desc:'Places 3 stages → fights OFF stage → dies with guards up → 3 energy refunded → respawns and executes',
    hp:900,ad:100,ai:0.7,shi:2,spd:85,chase:true,
    paceW:80,paceH:.08,startEn:0,msh:150,letSeraDie:true,seraHP:1200,
    dab:{Q:{cd:0,mcd:1.5,name:'Pummel',col:'#ef5350'},W:{cd:0,mcd:5,name:'Iron Skin',col:'#00e5ff'},E:{cd:0,mcd:3.5,name:'Sap',col:'#66bb6a'},R:{cd:0,mcd:7,name:'Execute',col:'#ffa726'}}
  },
];

function runD(){
  const db=document.getElementById('demoBtnFloat');if(db)db.style.display='none';
  const s=G.s;
  s.hp=s.mhp;s.mn=s.mmn;s.en=0;s.x=W/2;s.y=H*.55;
  for(const k in s.cd)s.cd[k]=0;s.gcd=[0,0,0];
  G.stg=[];G.proj=[];G.fx=[];moveTo=null;
  s.dA=1;s.amp=false;s.ecR=false;s.ecU=false;G._dMov=null;s.qPhase=0;s.qRecast=0;
  G.en=[];G.stg=[];G.proj=[];G.fx=[];moveTo=null;
  s.hp=1500;s.mhp=1500;s.spd=240;
  G.dOn=true;G.dQ=[];G.dT=0;
  G.ai={
    round:0,
    phase:'intro',
    stagesPlaced:0,
    thinkCD:0,
    dodgeDir:1,
    dodgeT:0,
    killPauseT:0,
    introT:0,
    stageSpots:[],
    refundExecute:false,
  };
  spawnRound(0);
}

function spawnRound(idx){
  const s=G.s;const ai=G.ai;
  const r=ROUNDS[idx % ROUNDS.length];
  ai.round=idx;ai.stagesPlaced=0;ai.killPauseT=0;ai.sawShield=false;ai.shieldBrokeT=null;ai.refundExecute=false;
  // Skip to action — if we have energy, fight; otherwise place stages
  if(s.en>=2){ai.phase='fight';ai.thinkCD=0.1;}
  else{ai.phase='setup';ai.thinkCD=0;}
  // Clear old stages and reset
  G.stg=[];for(let i=0;i<3;i++)s.gcd[i]=0;
  s.en=r.startEn;s.mn=s.mmn;s.qPhase=0;s.qRecast=0;
  for(const k in s.cd)s.cd[k]=0;
  G._dMov=null;
  // For guard reset showcase: put one guard on cooldown so the reset is visible
  if(r.guardOnCD){s.gcd[0]=11;}
  // Remove old dummy
  G.en=G.en.filter(e=>e.jnk);
  // Spawn new dummy in the combat zone between turrets
  // Enemy turret at H*.08 range 180, ally turret at H*.85 range 180
  // Safe combat zone roughly H*.33 to H*.62
  const dy=H*.36;const dx=W/2+(Math.random()-.5)*40;
  const laneHalf=130;
  const allyTurSafe=G.tur?(G.tur.y-G.tur.rng-15):H*.62;
  const d=mkE(dx,dy,{
    hp:r.hp,shi:r.shi,rt:99,sx:dx,sy:dy,ar:260,ai:r.ai,ad:r.ad,
    msh:r.msh||160,
    chase:r.chase,spd:r.chase?r.spd:0,
    pace:!r.chase,paceSpd:r.spd,
    paceXMin:W/2-laneHalf,paceXMax:W/2+laneHalf,
    paceYMin:dy-H*r.paceH,paceYMax:Math.min(dy+H*r.paceH,allyTurSafe),
    dab:r.dab?JSON.parse(JSON.stringify(r.dab)):undefined
  });
  G.en.push(d);
  // Show round label
  ftxt(W/2,H*.05,`— ${r.name} —`,'#f48fb1',20);
  ring(W/2,H*.05,'#f48fb1',60,.5);
  // Show persistent banner
  const rb=document.getElementById('roundBanner');
  const rbT=document.getElementById('rbTitle');
  const rbD=document.getElementById('rbDesc');
  if(rb){rb.style.display='block';rbT.textContent=`ROUND ${(idx%ROUNDS.length)+1}: ${r.name.toUpperCase()}`;rbD.textContent=r.desc||'';}
  // Apply custom Sera HP for specific rounds (e.g. dying round)
  if(r.seraHP){s.hp=r.seraHP;s.mhp=r.seraHP;}
  // Update hint
  const ht=document.getElementById('hintBar');
  if(ht)ht.textContent=`Round ${idx+1}: ${r.name}`;
}

function skipRound(dir){
  if(!G.ai)return;
  const ai=G.ai;
  const next=Math.max(0,ai.round+dir);
  const s=G.s;
  s.hp=s.mhp;s.mn=s.mmn;s.alive=true;s.inv=0.5;
  G.stg=[];G.proj=[];G.fx=[];G._dMov=null;
  for(let i=0;i<3;i++)s.gcd[i]=0;
  s.x=W/2;s.y=H*.55;
  spawnRound(next);
}

function aiTick(dt){
  const ai=G.ai;if(!ai)return;
  const s=G.s;if(!s||!s.alive)return;
  const d=G.en.find(e=>e.alive&&!e.jnk);

  // ─── KILL PAUSE — dummy died, wait then spawn next ───
  if(ai.phase==='kill_pause'){
    ai.killPauseT+=dt;
    G._dMov={x:W/2,y:H*.50};
    if(ai.killPauseT>2){
      s.hp=Math.min(s.mhp,s.hp+s.mhp*.70);
      s.mn=s.mmn;
      // If we just finished the execute phase of round 6, loop back to round 6 death phase
      const curRnd=ROUNDS[ai.round % ROUNDS.length];
      if(curRnd.letSeraDie&&ai.refundExecute){
        ai.refundExecute=false;
        s.en=0; // reset energy to 0 for the loop
        spawnRound(ai.round); // same round, not +1
      } else {
        spawnRound(ai.round+1);
      }
    }
    return;
  }

  // Dummy just died → kill pause
  if(!d){
    ai.phase='kill_pause';ai.killPauseT=0;
    ftxt(s.x,s.y-60,'✦ KILL ✦','#ff1744',24);
    return;
  }

  // ─── SHIELD BREAK ROUND — auto-advance after shield shattered AND dummy chunked to half HP ───
  const curR=ROUNDS[ai.round % ROUNDS.length];
  if(curR.name==='Shield Breaker'){
    if(d.sh>0)ai.sawShield=true;
    // Both conditions: shield was broken by E AND dummy is below 50% HP
    if(ai.sawShield&&d.sh<=0&&d.hp<d.mhp*0.5){
      if(!ai.shieldBrokeT){ai.shieldBrokeT=0;ftxt(d.x,d.y-55,'SHIELD BROKEN + CHUNKED — ROUND COMPLETE','#00e5ff',14);}
      ai.shieldBrokeT+=dt;
      if(ai.shieldBrokeT>2.5){
        ai.shieldBrokeT=null;ai.sawShield=false;
        s.hp=Math.min(s.mhp,s.hp+s.mhp*.70);s.mn=s.mmn;
        spawnRound(ai.round+1);
      }
      G._dMov={x:W/2,y:H*.50};
      return;
    }
  }

  ai.thinkCD-=dt;
  ai.dodgeT+=dt;
  if(ai.thinkCD>0)return;

  // ─── INTRO — skip to action immediately ───
  if(ai.phase==='intro'){
    if(s.en>=2){ai.phase='fight';ai.thinkCD=0;}
    else{ai.phase='setup';ai.thinkCD=0;}
    return;
  }

  // ─── GAME STATE ───
  const dist=Math.hypot(d.x-s.x,d.y-s.y);
  const inRange=dist<280;
  const hasQ=s.cd.Q<=0;
  const hasE=s.cd.E<=0&&s.mn>=s.mc.E;
  const hasR=s.cd.R<=0&&s.en>=s.ec.R;
  const hasQ1=s.mn>=s.mc.Q1;
  const canQ2=s.qPhase===1;
  const shielded=d.sh>0;
  const silenced=d.si>0;
  const activeGuards=G.stg.filter(st=>st.act).length;
  const onStage=s.onS&&s.onS.act;
  const availGuards=s.gcd.filter(cd=>cd<=0).length - activeGuards;
  const lowHP=s.hp<s.mhp*.25;
  const canPlaceW=availGuards>0&&s.cd.W<=0;

  // ─── LANE BOUNDARIES — respect both turret zones ───
  // Ally T1 turret at H*.85, enemy T1 at H*.08, both range 180
  // Sera must not enter enemy turret range (top of lane)
  // Dummy must not enter ally turret range (bottom of lane)
  const laneL=W/2-140, laneR=W/2+140;
  const eTurEdge=G.etur?(G.etur.y+G.etur.rng):H*.25; // bottom edge of enemy turret range
  const aTurEdge=G.tur?(G.tur.y-G.tur.rng):H*.68;   // top edge of ally turret range
  const seraTop=eTurEdge+15; // Sera stays below enemy turret range + buffer
  const seraBot=H*.72;       // Sera can go near own turret safely
  const dummyBot=aTurEdge-15; // Dummy stays above ally turret range + buffer

  // ─── MOVEMENT HELPERS ───
  function mv(x,y){G._dMov={x:Math.max(laneL,Math.min(laneR,x)),y:Math.max(seraTop,Math.min(seraBot,y))};}
  function laneStrafe(){
    // Strafe side-to-side within lane while staying at current Y depth
    if(ai.dodgeT>0.5+Math.random()*.4){ai.dodgeDir*=-1;ai.dodgeT=0;}
    const tx=s.x+ai.dodgeDir*35;
    mv(tx,s.y);
  }
  function approachDummy(){
    // Walk toward the dummy along the lane
    mv(W/2+(Math.random()-.5)*30, s.y+(d.y<s.y?-60:60));
  }
  function moveToStage(st){mv(st.x,st.y);}
  function holdLanePos(){
    // Stay at a comfortable trading distance below the dummy (like a real mid laner)
    const idealY=Math.max(seraTop,Math.min(seraBot,d.y+100));
    mv(W/2+(Math.random()-.5)*40, idealY);
  }

  // ─── SETUP — Place 3 stages ALONG the lane vertically ───
  if(ai.phase==='setup'){
    if(ai.stagesPlaced<3){
      if(s.cd.W>0){ai.thinkCD=.05;return;}
      let gi=-1;for(let i=0;i<3;i++){if(s.gcd[i]<=0&&!G.stg.find(st=>st.gi===i&&st.act)){gi=i;break;}}
      if(gi<0){ai.phase='fight';ai.thinkCD=.1;return;}

      const curSetupR=ROUNDS[ai.round % ROUNDS.length];
      let stagePositions;

      if(curSetupR.letSeraDie&&!ai.refundExecute){
        // DYING PHASE: place stages far back near own turret — fighting happens up near dummy
        stagePositions=[
          {x:W/2-40, y:seraBot-10},   // far back left
          {x:W/2,    y:seraBot-70},    // far back center
          {x:W/2+40, y:seraBot-10},    // far back right
        ];
      } else {
        // Normal placement or execute phase: along the lane
        const midY=Math.max(seraTop,(s.y+d.y)/2);
        stagePositions=[
          {x:W/2+15, y:Math.min(seraBot,s.y+15)},
          {x:W/2-15, y:midY},
          {x:W/2+10, y:Math.max(seraTop,midY-40)},
        ];
      }

      const target=stagePositions[ai.stagesPlaced%3];
      const sd=Math.hypot(s.x-target.x,s.y-target.y);
      if(sd>18){mv(target.x,target.y);ai.thinkCD=.04;return;}
      doCast('W');
      // For dying round: guards must survive until Sera dies — give them massive HP
      // sDie() sets st.act=false directly so this doesn't interfere with the death refund
      if(curSetupR.letSeraDie&&!ai.refundExecute){
        const lastStg=G.stg[G.stg.length-1];
        if(lastStg){lastStg.gh=99999;lastStg.gmh=99999;}
      }
      ai.stagesPlaced++;
      ai.thinkCD=.15;
      return;
    }
    ai.phase='fight';ai.thinkCD=.15;return;
  }

  // ─── FIGHT — Unified reactive combat ───
  if(ai.phase==='fight'){

    // ─── ROUND 6 LOGIC: Energy Refund on Death ───
    // The AI understands the GOAL of this round, not a script.
    // Dying phase goal: fight the dummy off stages, lose the fight, die with all 3 guards up.
    // Execute phase goal: use full kit freely to kill the dummy — normal AI takes over.
    const curRound=ROUNDS[ai.round % ROUNDS.length];

    // DYING PHASE — Sera fights dynamically but stays off her stages
    if(curRound.letSeraDie&&!ai.refundExecute){

      // Stay in fighting range of the dummy
      if(dist>210){approachDummy();ai.thinkCD=.05;return;}

      // AWARENESS: avoid all active stages — she knows guards must survive
      for(const st of G.stg){
        if(!st.act)continue;
        if(Math.hypot(s.x-st.x,s.y-st.y)<st.r+20){
          // Move toward the dummy instead — that's where the fight is
          const ang=Math.atan2(d.y-s.y,d.x-s.x);
          mv(s.x+Math.cos(ang)*90, s.y+Math.sin(ang)*90);
          ai.thinkCD=.06;return;
        }
      }

      // Dynamic fighting — she's trying but losing. Vary behavior each tick.
      const r6roll=Math.random();
      if(r6roll<0.20){
        // Strafe to dodge — she's trying to survive
        laneStrafe();ai.thinkCD=.15+Math.random()*.2;return;
      }
      if(r6roll<0.45&&hasQ&&!canQ2&&hasQ1){
        // Q1 poke — main trading tool
        if(Math.random()<0.4)laneStrafe();
        doCastQ();ai.thinkCD=.6+Math.random()*.5;return;
      }
      if(r6roll<0.60&&hasE&&s.cd.Q>0.3){
        // E chip damage
        if(Math.random()<0.3)laneStrafe();
        doCast('E');ai.thinkCD=.5+Math.random()*.5;return;
      }
      // Otherwise hold position and take hits — the fight is wearing her down
      if(Math.random()<0.25)laneStrafe();
      ai.thinkCD=.3+Math.random()*.4;return;
    }

    // EXECUTE PHASE — normal full-kit AI, no restrictions
    // (falls through to the standard fight priorities below)

    // ALWAYS: if too far from dummy, walk toward it
    if(dist>200){approachDummy();ai.thinkCD=.04;return;}

    // PRIORITY 0: Need stages? Place W right here
    if(activeGuards===0&&canPlaceW&&s.en<2){
      ai.phase='setup';ai.stagesPlaced=0;ai.thinkCD=.1;return;
    }

    // PRIORITY 1: Shield up → E to break
    if(shielded&&hasE){
      laneStrafe();doCast('E');ai.thinkCD=.35;return;
    }

    // PRIORITY 2: Q2 recast window → always fire if have energy
    if(canQ2&&s.en>=s.ec.Q2){
      laneStrafe();doCastQ();ai.thinkCD=.4;return;
    }

    // PRIORITY 3: Have R energy → silence opener
    if(hasR&&!silenced){
      laneStrafe();doCast('R');ai.thinkCD=.25;return;
    }

    // PRIORITY 4: Need energy → stand on active stage while fighting
    if(s.en<2&&activeGuards>0&&!onStage){
      let nearest=null,nd=1e9;
      for(const st of G.stg){if(!st.act)continue;const dd=Math.hypot(st.x-s.x,st.y-s.y);if(dd<nd){nd=dd;nearest=st;}}
      if(nearest&&nd>20){moveToStage(nearest);
        if(hasQ&&!canQ2&&hasQ1&&dist<280){doCastQ();ai.thinkCD=.3;return;}
        if(hasE&&dist<280&&s.cd.Q>1){doCast('E');ai.thinkCD=.3;return;}
        ai.thinkCD=.04;return;
      }
    }

    // PRIORITY 5: On a stage absorbing — still fight!
    if(onStage&&s.en<2){
      if(hasQ&&!canQ2&&hasQ1){doCastQ();ai.thinkCD=.4;return;}
      if(hasE&&s.cd.Q>1.2){doCast('E');ai.thinkCD=.35;return;}
      ai.thinkCD=.15;return;
    }

    // PRIORITY 6: Q1 poke
    if(hasQ&&!canQ2&&hasQ1){
      laneStrafe();doCastQ();ai.thinkCD=.4;return;
    }

    // PRIORITY 7: E chip damage
    if(hasE&&s.cd.Q>1){
      laneStrafe();doCast('E');ai.thinkCD=.35;return;
    }

    // PRIORITY 8: Need stages
    if(canPlaceW&&activeGuards<2){
      ai.phase='setup';ai.stagesPlaced=0;ai.thinkCD=.15;return;
    }

    // Default: orbit the dummy, stay in the fight
    laneStrafe();
    ai.thinkCD=.1;return;
  }

  ai.thinkCD=.08;
}

// ═══ KITE AIM TRAINER ═══
const KITE_LEVELS=[
  {name:'Q Basics',dur:60,
   desc:'PINK targets → press Q. Dodge red projectiles or use W stage!',
   tgtR:30,tgtSpd:18,tgtInt:1.8,tgtLife:6,tgtMax:3,
   projInt:3.5,projSpd:150,projCnt:1,projR:7,
   types:['q1'],shieldPct:0,needR:false,scoreMult:1},
  {name:'Precision Q',dur:70,
   desc:'GOLD ★ targets are smaller, worth 2x. Same Q key. Keep dodging!',
   tgtR:26,tgtSpd:30,tgtInt:1.6,tgtLife:5.5,tgtMax:3,
   projInt:3.0,projSpd:170,projCnt:1,projR:7,
   types:['q1','q2'],shieldPct:0,needR:false,scoreMult:1.2},
  {name:'E Shield Break',dur:75,
   desc:'CYAN targets have shields. Press E to shatter, then Q. Dodge fire!',
   tgtR:24,tgtSpd:35,tgtInt:1.5,tgtLife:6,tgtMax:3,
   projInt:2.8,projSpd:185,projCnt:1,projR:8,
   types:['q1','q2','shield'],shieldPct:0.35,needR:false,scoreMult:1.4},
  {name:'R Silence',dur:80,
   desc:'PURPLE targets need R to silence first, THEN Q. Dodge or use W!',
   tgtR:24,tgtSpd:38,tgtInt:1.5,tgtLife:6,tgtMax:3,
   projInt:2.5,projSpd:200,projCnt:2,projR:8,
   types:['q1','q2','shield','r_tgt'],shieldPct:0.2,needR:true,scoreMult:1.6},
  {name:'All Targets',dur:85,
   desc:'All 4 target types. Match the key to the color. Fire intensifies!',
   tgtR:22,tgtSpd:48,tgtInt:1.3,tgtLife:5.5,tgtMax:4,
   projInt:2.2,projSpd:220,projCnt:2,projR:8,
   types:['q1','q2','shield','r_tgt'],shieldPct:0.25,needR:true,scoreMult:1.8},
  {name:'Under Fire',dur:90,
   desc:'Dodge red projectiles while aiming. Place W for guard shields.',
   tgtR:20,tgtSpd:60,tgtInt:1.2,tgtLife:5,tgtMax:4,
   projInt:2.5,projSpd:220,projCnt:2,projR:8,
   types:['q1','q2','shield','r_tgt'],shieldPct:0.25,needR:true,scoreMult:2.0},
  {name:'Fast & Small',dur:95,
   desc:'Smaller targets, faster movement, incoming fire.',
   tgtR:18,tgtSpd:75,tgtInt:1.1,tgtLife:4.5,tgtMax:5,
   projInt:2.0,projSpd:260,projCnt:2,projR:9,
   types:['q1','q2','shield','r_tgt'],shieldPct:0.3,needR:true,scoreMult:2.3},
  {name:'Precision Hell',dur:100,
   desc:'Tiny targets, heavy fire. Every shot counts.',
   tgtR:15,tgtSpd:85,tgtInt:1.0,tgtLife:4,tgtMax:5,
   projInt:1.5,projSpd:290,projCnt:3,projR:9,
   types:['q1','q2','shield','r_tgt'],shieldPct:0.3,needR:true,scoreMult:2.6},
  {name:'Chaos',dur:110,
   desc:'Maximum targets, relentless fire. Full mastery required.',
   tgtR:14,tgtSpd:100,tgtInt:0.9,tgtLife:3.5,tgtMax:6,
   projInt:1.2,projSpd:320,projCnt:4,projR:10,
   types:['q1','q2','shield','r_tgt'],shieldPct:0.3,needR:true,scoreMult:3.0},
  {name:'IMPOSSIBLE',dur:120,
   desc:'Tiny. Fast. Relentless. S+ here = god tier.',
   tgtR:12,tgtSpd:120,tgtInt:0.7,tgtLife:3,tgtMax:6,
   projInt:0.9,projSpd:350,projCnt:5,projR:10,
   types:['q1','q2','shield','r_tgt'],shieldPct:0.35,needR:true,scoreMult:3.5},
];

function showKiteSelect(){
  document.getElementById('kiteResults').style.display='none';
  document.getElementById('kiteHUD').style.display='none';
  document.getElementById('wrap').classList.remove('on');
  const sel=document.getElementById('kiteSelect');
  sel.style.display='flex';
  const c=document.getElementById('kiteLvls');
  c.innerHTML='';
  // Color legend
  const leg=document.createElement('div');
  leg.style.cssText='margin-bottom:14px;text-align:center;line-height:2;font-size:13px;color:#f0e6d2;max-width:500px;';
  leg.innerHTML=
    `<div style="font:bold 13px Orbitron;color:#c8aa6e;letter-spacing:2px;margin-bottom:6px;">DODGE & AIM — No Cooldowns!</div>`+
    `<span style="color:#e84393;font-weight:bold;">● PINK</span> = press <span style="color:#e84393;font-weight:bold;">Q</span> &nbsp;&nbsp;`+
    `<span style="color:#ffd700;font-weight:bold;">● GOLD ★</span> = press <span style="color:#ffd700;font-weight:bold;">Q</span> (smaller, 2x pts) &nbsp;&nbsp;`+
    `<span style="color:#00bcd4;font-weight:bold;">● CYAN</span> = <span style="color:#2196f3;font-weight:bold;">E</span> break shield, then <span style="font-weight:bold;">Q</span> &nbsp;&nbsp;`+
    `<span style="color:#aa00ff;font-weight:bold;">● PURPLE</span> = <span style="color:#aa00ff;font-weight:bold;">R</span> to silence, then <span style="font-weight:bold;">Q</span><br>`+
    `<span style="color:#ef5350;font-weight:bold;">⚠ Hit OFF stage = -50 pts + streak lost</span> · <span style="color:#4caf50;">ON stage = safe (guards absorb)</span><br>`+
    `<span style="color:#ef5350;">Miss = -30 pts</span> · <span style="color:#4caf50;">Streak bonus = +10% per hit (max 3x)</span> · <span style="color:#ffd700;">W = place guard stage</span>`;
  c.appendChild(leg);
  // Level buttons
  const grid=document.createElement('div');
  grid.style.cssText='display:flex;flex-wrap:wrap;gap:8px;justify-content:center;max-width:520px;';
  for(let i=0;i<10;i++){
    const L=KITE_LEVELS[i];
    const tier=i<3?0:i<6?1:i<8?2:3;
    const tierCol=['#c8aa6e','#f48fb1','#ff5252','#ff1744'][tier];
    const durTxt=L.dur>=60?`${Math.floor(L.dur/60)}m${L.dur%60>0?(L.dur%60+'s'):''}`:L.dur+'s';
    const b=document.createElement('button');
    b.style.cssText=`width:155px;padding:8px 8px;border:1px solid ${tierCol};background:rgba(30,35,40,.9);color:#f0e6d2;cursor:pointer;border-radius:4px;text-align:left;`;
    b.innerHTML=`<div style="display:flex;align-items:center;gap:6px;margin-bottom:3px;"><span style="font:bold 18px Orbitron;color:${tierCol};">${i+1}</span><span style="font:bold 11px Orbitron;color:${tierCol};letter-spacing:1px;">${L.name}</span></div>`+
      `<div style="font-size:10px;color:rgba(240,230,210,.55);line-height:1.3;">${L.desc}</div>`+
      `<div style="font-size:9px;color:rgba(200,170,110,.4);margin-top:3px;">${durTxt}</div>`;
    b.onmouseenter=()=>{b.style.borderColor='#fff';b.style.background='rgba(60,50,30,.9)';};
    b.onmouseleave=()=>{b.style.borderColor=tierCol;b.style.background='rgba(30,35,40,.9)';};
    b.onclick=()=>kiteStart(i);
    grid.appendChild(b);
  }
  c.appendChild(grid);
}

function kiteStart(lvl){
  document.getElementById('kiteSelect').style.display='none';
  document.getElementById('kiteResults').style.display='none';
  document.getElementById('kiteHUD').style.display='block';
  document.getElementById('wrap').classList.add('on');
  const ap=document.getElementById('abilPanel');ap.classList.remove('on');
  const br=document.getElementById('bhudR');br.innerHTML='';
  const ht=document.getElementById('hintBar');ht.textContent='Right-Click Move · Hover to aim · Q / E / R to shoot · W = place stage (safe from hits)';
  document.getElementById('mTag').textContent='AIM TRAINER';
  mode='kite';
  const L=KITE_LEVELS[lvl];
  resize();G.s=mkS();const s=G.s;drawChampIcon();
  G.en=[];G.stg=[];G.proj=[];G.fx=[];G.dQ=[];G.dT=0;G.dOn=false;G.tur=null;G.etur=null;G.jT=0;G.jA=false;G.jk=null;G._dMov=null;
  s.x=W/2;s.y=H*.55;s.hp=800;s.mhp=800;
  s.en=3;s.men=3; // Start with full energy
  // Faster guard cooldowns in aim trainer (5s vs 11s)
  for(let i=0;i<3;i++)s.gcd[i]=0;
  s._kiteGCD=5; // guard CD override for kite mode
  // No turrets in aim trainer — full arena
  G.kite={
    lvl:lvl,L:L,
    timer:L.dur,
    score:0,
    hits:0,misses:0,fired:0,
    streak:0,bestStreak:0,
    dmgTaken:0,dmgBlocked:0,
    tgtSpawnT:1.5, // initial delay before first target
    projSpawnT:Math.max(2,L.projInt), // delay before first projectile
    tgtsSpawned:0,tgtsExpired:0,
    active:true,
    maxPossible:0,
  };
  run=true;lt=performance.now();raf=requestAnimationFrame(loop);
}

function kiteSpawnTgt(){
  const k=G.kite;const L=k.L;
  const activeTgts=G.en.filter(e=>e.alive&&e.ktgt);
  if(activeTgts.length>=L.tgtMax)return;
  // Pick type
  const types=L.types;
  let tp=types[Math.floor(Math.random()*types.length)];
  // Force shield type based on shieldPct
  if(L.shieldPct>0&&Math.random()<L.shieldPct&&types.includes('shield'))tp='shield';
  // Spawn in combat area
  const margin=60;
  const tx=margin+Math.random()*(W-margin*2);
  const ty=H*.12+Math.random()*(H*.55);
  // Target appearance based on type
  let col,lbl,r=L.tgtR,msh=0,hp=1;
  if(tp==='q1'){col='#e84393';lbl='Q';r=L.tgtR;hp=100;}
  else if(tp==='q2'){col='#ffd700';lbl='Q ★';r=Math.max(8,L.tgtR*.5);hp=100;} // small precision Q target
  else if(tp==='shield'){col='#00bcd4';lbl='E → Q';r=L.tgtR;hp=100;msh=80;}
  else if(tp==='r_tgt'){col='#aa00ff';lbl='R → Q';r=L.tgtR;hp=150;}
  const tgt=mkE(tx,ty,{
    hp:hp,mhp:hp,shi:99,rt:99,sx:tx,sy:ty,ar:0,ai:99,ad:0,
    col:col,lbl:lbl,msh:msh,
    pace:true,paceSpd:L.tgtSpd,
    paceXMin:Math.max(margin,tx-120),paceXMax:Math.min(W-margin,tx+120),
    paceYMin:Math.max(H*.1,ty-80),paceYMax:Math.min(H*.6,ty+80),
  });
  tgt.ktgt=tp; // mark as kite target
  tgt.klife=L.tgtLife;
  tgt.kage=0;
  tgt.r=r;
  if(msh>0)tgt.sh=msh;
  G.en.push(tgt);
  k.tgtsSpawned++;
  // Track max possible score
  const pts=tp==='q2'?200:tp==='shield'?250:tp==='r_tgt'?300:100;
  k.maxPossible+=pts;
}

function kiteSpawnProj(){
  const k=G.kite;const L=k.L;const s=G.s;
  if(!s||!s.alive)return;
  // Fire projectiles from random edges toward Sera
  for(let i=0;i<L.projCnt;i++){
    const side=Math.floor(Math.random()*3); // 0=top, 1=left, 2=right
    let px,py;
    if(side===0){px=W*.1+Math.random()*W*.8;py=-20;}
    else if(side===1){px=-20;py=H*.1+Math.random()*H*.5;}
    else{px=W+20;py=H*.1+Math.random()*H*.5;}
    // Aim at Sera with some spread
    const spread=(Math.random()-.5)*60;
    const tx=s.x+spread;const ty=s.y+(Math.random()-.5)*40;
    // Lifetime calculated from screen diagonal — projectile must always be able to cross the entire screen
    const screenDiag=Math.hypot(W,H)+200;
    const projLife=Math.max(6, screenDiag/L.projSpd);
    G.proj.push(mkP('dA',px,py,tx,ty,{li:projLife,sp:L.projSpd,r:L.projR,dmg:40+k.lvl*8}));
  }
}

function kiteTick(dt){
  const k=G.kite;if(!k||!k.active)return;
  const s=G.s;const L=k.L;
  // Timer
  k.timer-=dt;
  if(k.timer<=0){k.timer=0;k.active=false;kiteEnd();return;}
  // HP regen (15/sec)
  if(s.alive)s.hp=Math.min(s.mhp,s.hp+15*dt);
  // Slow energy regen (1 per 8s) so player isn't permanently locked out
  if(!k._eRegen)k._eRegen=0;
  k._eRegen+=dt;
  if(k._eRegen>=8&&s.en<s.men){s.en=Math.min(s.men,s.en+1);k._eRegen=0;ftxt(s.x,s.y-55,'+1⚡ REGEN','#ffd700',11);}
  // Spawn targets
  k.tgtSpawnT-=dt;
  if(k.tgtSpawnT<=0){
    kiteSpawnTgt();
    k.tgtSpawnT=L.tgtInt+Math.random()*L.tgtInt*.3;
  }
  // Spawn projectiles
  if(L.projCnt>0){
    k.projSpawnT-=dt;
    if(k.projSpawnT<=0){
      kiteSpawnProj();
      k.projSpawnT=L.projInt+Math.random()*L.projInt*.2;
    }
  }
  // Age targets — expire if too old
  for(const d of G.en){
    if(!d.alive||!d.ktgt)continue;
    d.kage+=dt;
    if(d.kage>=d.klife){
      // Target expired — penalty
      d.alive=false;d.hp=0;d.dt=0;
      k.tgtsExpired++;
      k.streak=0;
      burst(d.x,d.y,'#555',10,30,.3);
      ftxt(d.x,d.y-30,'EXPIRED','#ef5350',14);
    }
  }
  // Update kite HUD
  const acc=k.fired>0?Math.round(k.hits/k.fired*100):100;
  document.getElementById('khScore').textContent=Math.round(k.score);
  document.getElementById('khStreak').textContent=k.streak>1?`${k.streak}x STREAK`:'';
  document.getElementById('khAcc').textContent=`Accuracy: ${acc}% · Hits: ${k.hits} · Misses: ${k.misses}`;
  const mins=Math.floor(k.timer/60);const secs=Math.ceil(k.timer%60);
  document.getElementById('khTimer').textContent=mins>0?`${mins}:${secs<10?'0':''}${secs}`:`${secs}s`;
  if(k.timer<10)document.getElementById('khTimer').style.color='#ef5350';
  else document.getElementById('khTimer').style.color='#f0e6d2';
  document.getElementById('khLevel').textContent=`LEVEL ${k.lvl+1}: ${L.name.toUpperCase()}`;
}

function kiteHit(d,p){
  // Called when a kite target is hit by a player projectile
  const k=G.kite;if(!k)return;
  const tp=d.ktgt;
  let pts=0;
  let bonus='';
  // Q targets (pink) — hit with Q
  if(tp==='q1'&&p.tp==='Q1'){pts=100;bonus='HIT';}
  // Precision Q targets (gold, smaller) — hit with Q for big points
  else if(tp==='q2'&&p.tp==='Q1'){pts=200;bonus='PRECISION';}
  // Shield targets — E breaks shield first
  else if(tp==='shield'&&p.tp==='E'){
    pts=80;bonus='SHIELD SHATTERED';
    d.sh=0;d.hp=d.mhp;
    burst(d.x,d.y,'#00e5ff',14,40,.4);
    k.score+=pts*streakMult(k);k.hits++;k.streak++;k.bestStreak=Math.max(k.bestStreak,k.streak);
    ftxt(d.x,d.y-45,`+${Math.round(pts*streakMult(k))} ${bonus}`,'#00e5ff',13);
    return false; // don't kill — wait for Q follow-up
  }
  else if(tp==='shield'&&d.sh<=0&&p.tp==='Q1'){
    pts=170;bonus='E→Q COMBO';
  }
  else if(tp==='shield'&&d.sh>0&&p.tp==='Q1'){pts=30;bonus='SHIELD BLOCKED — USE E';} 
  // R targets — R silences first, then Q for big damage
  else if(tp==='r_tgt'&&p.tp==='R'){
    pts=100;bonus='SILENCED';
    d.rA=6;d.si=3;d.hp=d.mhp;
    burst(d.x,d.y,'#aa00ff',14,40,.4);
    k.score+=pts*streakMult(k);k.hits++;k.streak++;k.bestStreak=Math.max(k.bestStreak,k.streak);
    ftxt(d.x,d.y-45,`+${Math.round(pts*streakMult(k))} ${bonus}`,'#aa00ff',13);
    return false; // don't kill — wait for Q follow-up
  }
  else if(tp==='r_tgt'&&d.rA>0&&p.tp==='Q1'){
    pts=300;bonus='R→Q AMPLIFIED';
  }
  else if(tp==='r_tgt'&&d.rA<=0&&p.tp==='Q1'){pts=50;bonus='USE R FIRST';}
  // Wrong ability but still a hit
  else{pts=20;bonus='WRONG KEY';}

  const mult=streakMult(k);
  k.score+=pts*mult;
  k.hits++;
  k.streak++;
  k.bestStreak=Math.max(k.bestStreak,k.streak);
  const col=pts>=200?'#ffd700':pts>=100?'#f48fb1':'#ef9a9a';
  ftxt(d.x,d.y-45,`+${Math.round(pts*mult)} ${bonus}`,col,13);
  return true; // kill target
}

function kiteMiss(){
  const k=G.kite;if(!k||!k.active)return;
  k.misses++;
  k.streak=0;
  k.score=Math.max(0,k.score-30);
  ftxt(G.s.x,G.s.y-50,'-30 MISS','#ef5350',12);
}

function kiteFired(){
  const k=G.kite;if(!k||!k.active)return;
  k.fired++;
}

function kiteDmg(amt,onStage){
  const k=G.kite;if(!k||!k.active)return;
  if(onStage){
    k.dmgBlocked+=amt;
    // On stage = intended. Guards absorb, energy gained. No penalty.
  }else{
    k.dmgTaken+=amt;
    k.score=Math.max(0,k.score-50);
    k.streak=0;
    ftxt(G.s.x+20,G.s.y-40,'-50 HIT! DODGE OR USE W','#ef5350',13);
  }
}

function streakMult(k){return Math.min(3,1+k.streak*0.1);}

function kiteEnd(){
  const k=G.kite;const L=k.L;
  document.getElementById('kiteHUD').style.display='none';
  run=false;if(raf)cancelAnimationFrame(raf);
  const acc=k.fired>0?Math.round(k.hits/k.fired*100):100;
  const maxP=Math.max(1,k.maxPossible*L.scoreMult);
  const pct=Math.min(100,Math.round(k.score/maxP*100));
  let grade,gCol;
  if(pct>=95){grade='S+';gCol='#ffd700';}
  else if(pct>=88){grade='S';gCol='#ffd700';}
  else if(pct>=78){grade='A';gCol='#4caf50';}
  else if(pct>=65){grade='B';gCol='#2196f3';}
  else if(pct>=50){grade='C';gCol='#ff9800';}
  else if(pct>=35){grade='D';gCol='#ef5350';}
  else{grade='F';gCol='#b71c1c';}
  const rDiv=document.getElementById('kiteResults');
  rDiv.style.display='flex';
  document.getElementById('krGrade').textContent=grade;
  document.getElementById('krGrade').style.color=gCol;
  document.getElementById('krTitle').textContent=`Level ${k.lvl+1}: ${L.name}`;
  const elapsed=L.dur-k.timer;
  const eMins=Math.floor(elapsed/60);const eSecs=Math.round(elapsed%60);
  const timeStr=eMins>0?`${eMins}m ${eSecs}s`:`${eSecs}s`;
  document.getElementById('krStats').innerHTML=
    `Score: <b style="color:#ffd700">${Math.round(k.score)}</b><br>`+
    `Accuracy: <b>${acc}%</b> (${k.hits} hits / ${k.fired} fired)<br>`+
    `Best Streak: <b style="color:#f48fb1">${k.bestStreak}x</b><br>`+
    `Targets Expired: <b style="color:${k.tgtsExpired?'#ef5350':'#4caf50'}">${k.tgtsExpired}</b> / ${k.tgtsSpawned} spawned<br>`+
    `Time: <b>${timeStr}</b> / ${L.dur>=60?Math.floor(L.dur/60)+'m'+(L.dur%60>0?(L.dur%60+'s'):''):L.dur+'s'}<br>`+
    `Damage Taken: <b>${Math.round(k.dmgTaken)}</b> · Blocked by Guards: <b style="color:#ffd700">${Math.round(k.dmgBlocked)}</b>`;
}

// ═══ INIT ═══
function go(m){
  mode=m;document.getElementById('splash').classList.add('hide');document.getElementById('wrap').classList.add('on');
  document.getElementById('mTag').textContent={practice:'PRACTICE',demo:'DEMO',kite:'KITE & SURVIVE',sandbox:'SANDBOX'}[m];
  G.en=[];G.stg=[];G.proj=[];G.fx=[];G.dQ=[];G.dT=0;G.dOn=false;G.tur=null;G.etur=null;G.jT=0;G.jA=false;G.jk=null;G._dMov=null;
  resize();G.s=mkS();const s=G.s;drawChampIcon();
  const br=document.getElementById('bhudR');const ht=document.getElementById('hintBar');const ap=document.getElementById('abilPanel');
  ap.classList.remove('on'); // hide by default
  if(m==='practice'){s.x=W/2;s.y=H*.55;G.en.push(mkE(W/2,H*.36,{hp:1000,shi:4,rt:6,sx:W/2,sy:H*.36,ad:35,ai:1.6,ar:250,pace:true,paceSpd:55,paceXMin:W/2-90,paceXMax:W/2+90,paceYMin:H*.28,paceYMax:H*.44,msh:160,dab:{Q:{cd:0,mcd:3,name:'Bolt',col:'#ef5350'},W:{cd:0,mcd:6,name:'Barrier',col:'#00e5ff'},E:{cd:0,mcd:8,name:'Drain',col:'#66bb6a'},R:{cd:0,mcd:16,name:'Unleash',col:'#ffa726'}}}));G.tur={x:W/2,y:H*.85,r:22,rng:180,at:0,ai:.8,dmg:200};G.etur={x:W/2,y:H*.14,r:22,rng:180,at:0,ai:.8,dmg:200};G.jI=45+Math.random()*20;ap.classList.add('on');br.innerHTML='';ht.textContent='Right-Click Move · Hover to aim · Q / W / E / R';}
  else if(m==='demo'){s.x=W/2;s.y=H*.55;G.tur={x:W/2,y:H*.85,r:22,rng:180,at:0,ai:.8,dmg:200};G.etur={x:W/2,y:H*.14,r:22,rng:180,at:0,ai:.8,dmg:200};
    // Spawn a smart interactive dummy so players can fight immediately
    G.en.push(mkE(W/2,H*.36,{hp:1200,shi:3.5,rt:6,sx:W/2,sy:H*.36,ad:40,ai:1.4,ar:260,
      chase:false,spd:65,pace:true,paceSpd:60,
      paceXMin:W/2-110,paceXMax:W/2+110,paceYMin:H*.28,paceYMax:H*.44,msh:180,
      dab:{Q:{cd:0,mcd:2.5,name:'Bolt',col:'#ef5350'},W:{cd:0,mcd:4,name:'Barrier',col:'#00e5ff'},E:{cd:0,mcd:5,name:'Drain',col:'#66bb6a'},R:{cd:0,mcd:12,name:'Unleash',col:'#ffa726'}}
    }));
    ap.classList.add('on');br.innerHTML='';
    // Place demo button top-left, clear of ability panel
    let dBtn=document.getElementById('demoBtnFloat');
    if(!dBtn){dBtn=document.createElement('div');dBtn.id='demoBtnFloat';dBtn.style.cssText='position:fixed;top:36px;left:12px;z-index:45;';document.getElementById('wrap').appendChild(dBtn);}
    dBtn.innerHTML='<button class="dmb" onclick="runD()">▶ Watch Full Demo</button>';dBtn.style.display='block';
    ht.textContent='Fight the dummy or watch the full AI demo';}
  else if(m==='kite'){showKiteSelect();return;}
  else if(m==='sandbox'){s.x=W/2;s.y=H*.5;ap.classList.add('on');br.innerHTML='';ht.textContent='S = Dummy · D = Chaser · H = Healer pair at cursor';}
  if(!run){run=true;lt=performance.now();loop(lt);}
}
function menu(){run=false;if(raf)cancelAnimationFrame(raf);document.getElementById('splash').classList.remove('hide');document.getElementById('wrap').classList.remove('on');document.getElementById('abilPanel').classList.remove('on');const db=document.getElementById('demoBtnFloat');if(db)db.style.display='none';const rb=document.getElementById('roundBanner');if(rb)rb.style.display='none';document.getElementById('kiteSelect').style.display='none';document.getElementById('kiteResults').style.display='none';document.getElementById('kiteHUD').style.display='none';document.getElementById('infoScreen').style.display='none';G.ai=null;G.dOn=false;G.kite=null;G.en=[];G.stg=[];G.proj=[];G.fx=[];}
function showInfo(){document.getElementById('splash').classList.add('hide');document.getElementById('infoScreen').style.display='block';document.getElementById('infoScreen').scrollTop=0;}
function hideInfo(){document.getElementById('infoScreen').style.display='none';document.getElementById('splash').classList.remove('hide');}

// Ability panel highlight — flash the card when ability is used
function hiAb(key){
  const map={P:'apP',Q:'apQ',W:'apW',E:'apE',R:'apR'};
  const el=document.getElementById(map[key]);if(!el)return;
  el.classList.add('hi');el.scrollIntoView({behavior:'smooth',block:'nearest'});
  setTimeout(()=>el.classList.remove('hi'),1200);
}

// ═══ INPUT ═══
addEventListener('keydown',e=>{const s=G.s;if(!s||!s.alive)return;
  if(e.key==='q')castQ();if(e.key==='w')cast('W');if(e.key==='e')cast('E');if(e.key==='r')cast('R');
  if(mode==='sandbox'){if(e.key==='s'){G.en.push(mkE(mx,my,{hp:1400,shi:4,rt:7,sx:mx,sy:my}));}if(e.key==='d'){G.en.push(mkE(mx,my,{hp:1200,chase:true,spd:80,shi:5,ai:2,ad:28,ar:220,lbl:'Chaser',rt:8,sx:mx,sy:my}));}if(e.key==='h'){G.en.push(mkE(mx-30,my,{hp:1000,heal:true,shi:5,lbl:'Healer A',rt:7,sx:mx-30,sy:my}));G.en.push(mkE(mx+30,my,{hp:1000,heal:true,shi:5,lbl:'Healer B',rt:7,sx:mx+30,sy:my}));}}});
addEventListener('keyup',e=>{});
cv.addEventListener('mousemove',e=>{mx=e.clientX;my=e.clientY;});
cv.addEventListener('contextmenu',e=>{e.preventDefault();if(!G.dOn)moveTo={x:e.clientX,y:e.clientY};});
cv.addEventListener('click',e=>{if(G.dOn)return;moveTo={x:e.clientX,y:e.clientY};});

function loop(now){if(!run)return;const dt=Math.min((now-lt)/1000,.05);lt=now;update(dt);render();raf=requestAnimationFrame(loop);}
</script>
</body>
</html>
